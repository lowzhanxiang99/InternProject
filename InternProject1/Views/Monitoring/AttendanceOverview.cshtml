@using InternProject1.Models
@{
    ViewData["Title"] = "Attendance Overview";
    Layout = "_Layout";
    
    // Get data from ViewBag
    var attendanceRecords = ViewBag.AttendanceRecords as List<Attendance> ?? new List<Attendance>();
    var dateFrom = ViewBag.DateFrom as DateTime?;
    var dateTo = ViewBag.DateTo as DateTime?;
    var searchTerm = ViewBag.SearchTerm as string ?? "";
    var pageSize = (int)(ViewBag.PageSize ?? 10);
    var currentPage = (int)(ViewBag.CurrentPage ?? 1);
    var totalRecords = (int)(ViewBag.TotalRecords ?? 0);
    var totalPages = (int)(ViewBag.TotalPages ?? 0);
    
    // Get sorting parameters from query string
    var sortBy = Context.Request.Query["sortBy"].ToString();
    var sortOrder = Context.Request.Query["sortOrder"].ToString();
}

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<style>
    .attendance-overview-container {
        min-height: 100vh;
        padding: 20px;
        margin-left: 0px;
        width: 100%;
        overflow-x: hidden;
    }

    .page-header {
        margin-bottom: 30px;
    }

        .page-header h1 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 28px;
            color: #122539;
            margin: 0;
        }

        .page-header p {
            font-family: 'Poppins', sans-serif;
            color: #5A91CB;
            margin: 5px 0 0 0;
        }

        /* Back Button Styles */
.btn-back {
    background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    height: 42px;
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 100px;
    justify-content: center;
}

.btn-back:hover {
    background: linear-gradient(135deg, #5a6268 0%, #4a5258 100%);
    transform: translateY(-1px);
    color: white;
    text-decoration: none;
}

    .filter-section {
        border: 0px solid #C6E6FB;
        border-radius: 12px;
        padding: 5px;
        margin-bottom: 25px;
    }

    .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: flex-end;
    }

    .search-group {
        flex: 1;
        min-width: 300px;
    }

    .date-group {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .date-input-group {
        min-width: 180px;
    }

    .form-label {
        font-family: 'Poppins', sans-serif;
        font-weight: 500;
        font-size: 14px;
        color: #122539;
        margin-bottom: 8px;
        display: block;
    }

    .form-control-custom {
        font-family: 'Poppins', sans-serif;
        height: 42px;
        border: 1px solid #C6E6FB;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 14px;
        color: #122539;
        transition: all 0.2s ease;
        width: 100%;
    }

        .form-control-custom:focus {
            border-color: #5A91CB;
            box-shadow: 0 0 0 0.2rem rgba(90, 145, 203, 0.25);
            outline: none;
        }

    .btn-search {
        background: #5A91CB;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        height: 42px;
        font-family: 'Poppins', sans-serif;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

        .btn-search:hover {
            background: #4a81bb;
            transform: translateY(-1px);
        }

    .export-btn {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        height: 42px;
        font-family: 'Poppins', sans-serif;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 120px;
        justify-content: center;
    }

        .export-btn:hover {
            background: linear-gradient(135deg, #218838 0%, #1ca87a 100%);
            transform: translateY(-1px);
            color: white;
            text-decoration: none;
        }

    /* Table Styles */
    .table-container {
        background: #FFFFFF;
        border: 1px solid #C6E6FB;
        box-shadow: 0px 1px 4px rgba(88, 134, 166, 0.1);
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 25px;
    }

    .table-responsive {
        overflow-x: auto;
    }

    .attendance-table {
        width: 100%;
        border-collapse: collapse;
        font-family: 'Poppins', sans-serif;
    }

        .attendance-table thead {
            font-family: 'Poppins', sans-serif;
            font-style: normal;
            font-weight: 500;
            font-size: 16px;
            line-height: 24px;
            color: #2C5B8C;
            border-bottom: 2px solid #D6E3F2;
            padding: 16px 8px;
            background: #FFFFFF;
        }

        .attendance-table th {
            padding: 16px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            color: #122539;
            white-space: nowrap;
            cursor: pointer;
            position: relative;
            user-select: none;
            transition: background-color 0.2s ease;
        }

        .attendance-table th:hover {
            background-color: #e2e8f0;
        }

        .attendance-table th.sortable {
            padding-right: 30px; /* Space for sort icon */
        }

        .sort-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #5A91CB;
            opacity: 0.7;
        }

        .attendance-table thead th.sortable::after {
            content: '↕';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #2C5B8C;
            opacity: 0.5;
            transition: opacity 0.2s ease;
        }

        .attendance-table th.sort-asc .sort-icon::after {
            content: '↑';
            color: #2C5B8C;
            opacity: 2;
            font-weight: bold;
        }

        .attendance-table th.sort-desc .sort-icon::after {
            content: '↓';
            color: #2C5B8C;
            opacity: 2;
            font-weight: bold;
        }

        .attendance-table tbody tr {
            border-bottom: 1px solid #E2E8F0;
            transition: background-color 0.2s ease;
        }

            .attendance-table tbody tr:hover {
                background-color: #f8fafc;
            }

        .attendance-table td {
            padding: 14px 20px;
            font-size: 14px;
            color: #4a5568;
            vertical-align: middle;
        }

        /* Clear Button Styles */
.btn-clear {
    background: #5A91CB;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 16px;
    height: 42px;
    font-family: 'Poppins', sans-serif;
    font-weight: 500;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 6px;
    min-width: 100px;
    justify-content: center;
}

.btn-clear:hover {
    background: #5A91CB;
    transform: translateY(-1px);
    color: white;
    text-decoration: none;
}

    /* Status Badges */
    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
        text-align: center;
        min-width: 80px;
    }

    .status-present {
        background-color: rgba(40, 167, 69, 0.1);
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.2);
    }

    .status-late {
        background-color: rgba(255, 193, 7, 0.1);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.2);
    }

    .status-absent {
        background-color: rgba(220, 53, 69, 0.1);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.2);
    }

    .status-leave {
        background-color: rgba(111, 66, 193, 0.1);
        color: #6f42c1;
        border: 1px solid rgba(111, 66, 193, 0.2);
    }

    .status-default {
        background-color: rgba(108, 117, 125, 0.1);
        color: #6c757d;
        border: 1px solid rgba(108, 117, 125, 0.2);
    }

    /* Pagination */
.pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 32px;
    background: #FFFFFF;
    border-top: 1px solid #D6E3F2;
    border-radius: 0 0 12px 12px;
}

.pagination {
    margin: 0;
    font-family: 'Poppins', sans-serif;
}

    .pagination .page-item .page-link {
        color: #2C5B8C;
        background-color: #FFFFFF;
        border: 1px solid #C6E6FB;
        padding: 8px 16px;
        margin: 0 4px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 400;
        min-width: 40px;
        text-align: center;
        transition: all 0.2s ease;
        text-decoration: none;
    }

        .pagination .page-item .page-link:hover {
            background-color: #F3F8FB;
            border-color: #5A91CB;
            color: #122539;
        }

    .pagination .page-item.active .page-link {
        background-color: #D6E3F2;
        border-color: #5A91CB;
        color: #122539;
        font-weight: 500;
    }

    .pagination .page-item.disabled .page-link {
        color: #AAD9F9;
        background-color: #FFFFFF;
        border-color: #C6E3F2;
        cursor: not-allowed;
    }

.pagination-info {
    font-family: 'Poppins', sans-serif;
    font-size: 14px;
    color: #5A91CB;
    white-space: nowrap;
}

/* Remove the old pagination-section styles */
.pagination-section {
    display: none;
}

    /* Show entries dropdown */
    .show-entries {
        display: flex;
        align-items: center;
        gap: 10px;
    }

        .show-entries select {
            border: 1px solid #C6E6FB;
            border-radius: 6px;
            padding: 6px 10px;
            font-family: 'Poppins', sans-serif;
            font-size: 14px;
            color: #122539;
            background: white;
            cursor: pointer;
        }

        /* Export button loading state */
.export-btn.loading {
    opacity: 0.7;
    cursor: wait;
}

.export-btn.loading .spinner-border {
    display: inline-block;
}

.export-btn .spinner-border {
    display: none;
    width: 16px;
    height: 16px;
    border-width: 2px;
    margin-right: 8px;
}

/* Success/Error messages */
.alert-message {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 9999;
    min-width: 300px;
    max-width: 400px;
    animation: slideIn 0.3s ease-out;
}

@@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

    /* Responsive */
    @@media (max-width: 992px) {
        .filter-row {
            flex-direction: column;
            align-items: stretch;
        }

        .search-group {
            min-width: 100%;
        }

        .date-group {
            width: 100%;
            justify-content: space-between;
        }

        .date-input-group {
            flex: 1;
        }
    }

    @@media (max-width: 768px) {
        .attendance-overview-container {
            padding: 15px;
        }

        .page-header h1 {
            font-size: 24px;
        }

        .filter-section {
            padding: 15px;
        }

        .date-group {
            flex-direction: column;
        }

        .date-input-group {
            width: 100%;
        }

        .attendance-table th,
        .attendance-table td {
            padding: 10px 15px;
            font-size: 13px;
        }

        .pagination-section {
            flex-direction: column;
            text-align: center;
        }
    }

    @@media (max-width: 576px) {
        .attendance-overview-container {
            padding: 10px;
        }

        .page-header h1 {
            font-size: 20px;
        }

        .btn-search, .export-btn {
            width: 100%;
            justify-content: center;
        }

        .attendance-table {
            font-size: 12px;
        }

            .attendance-table th,
            .attendance-table td {
                padding: 8px 10px;
            }

        .status-badge {
            padding: 3px 8px;
            font-size: 11px;
            min-width: 70px;
        }
    }
</style>

<div class="attendance-overview-container">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="page-header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>Attendance Overview</h1>
                <p>View and manage employee attendance records</p>
            </div>
            <div>
                <button type="button" class="btn-back" onclick="goBack()">
                    <i class="bi bi-arrow-left"></i> Back
                </button>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <form method="get" action="@Url.Action("AttendanceOverview", "Monitoring")" id="filterForm">
                <input type="hidden" name="sortBy" id="sortBy" value="@sortBy" />
                <input type="hidden" name="sortOrder" id="sortOrder" value="@sortOrder" />
                <div class="filter-row">
                    <!-- Search Bar with Clear Button -->
                    <div class="search-group" style="position: relative;">
                        <label class="form-label">Search </label>
                        <input type="text" 
                               class="form-control-custom" 
                               name="searchTerm" 
                               id="searchTerm"
                               value="@searchTerm"
                               placeholder="Search by name, department, or status...">
                        @if (!string.IsNullOrEmpty(searchTerm))
                        {
                            <button type="button" 
                                    class="btn btn-sm btn-link" 
                                    style="position: absolute; right: 10px; top: 38px; padding: 0; color: #5A91CB;"
                                    onclick="clearSearch()"
                                    title="Clear search">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        }
                    </div>

                    <!-- Date Range -->
                    <div class="date-group">
                        <div class="date-input-group">
                            <label class="form-label">Date From</label>
                            <input type="date" 
                                   class="form-control-custom" 
                                   name="dateFrom" 
                                   id="dateFrom"
                                   value="@(dateFrom?.ToString("yyyy-MM-dd"))">
                        </div>
                        <div class="date-input-group">
                            <label class="form-label">Date To</label>
                            <input type="date" 
                                   class="form-control-custom" 
                                   name="dateTo" 
                                   id="dateTo"
                                   value="@(dateTo?.ToString("yyyy-MM-dd"))">
                        </div>
                    </div>

                    <button type="button" 
                            class="btn-clear"
                            onclick="resetToDefaults()"
                            title="Reset to default view">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset
                    </button>

                    <!-- Export Button -->
                    <button type="button" class="export-btn" id="exportBtn" onclick="exportToExcel()">
                        <span class="spinner-border spinner-border-sm"></span>
                        <i class="bi bi-download"></i> Export 
                    </button>
                </div>
            </form>
        </div>

        <!-- Table Section -->
        <div class="table-container" style="background: #FFFFFF; border: 1px solid #C6E3F2; box-shadow: 0px 1px 4px rgba(88, 134, 166, 0.25); border-radius: 12px; overflow: hidden; margin-bottom: 25px;">
            <div class="table-responsive" style="padding: 0 32px 20px 32px;">
                <table class="attendance-table">
                <thead>
                    <tr>
                        <th class="sortable @(sortBy == "Employee_ID" ? (sortOrder == "asc" ? "sort-asc" : "sort-desc") + " active" : "")" 
                            data-sort="Employee_ID">
                            ID
                            <span class="sort-icon"></span>
                        </th>
                        <th class="sortable @(sortBy == "EmployeeName" ? (sortOrder == "asc" ? "sort-asc" : "sort-desc") + " active" : "")" 
                            data-sort="EmployeeName">
                            Employee
                            <span class="sort-icon"></span>
                        </th>
                        <th class="sortable @(sortBy == "Department" ? (sortOrder == "asc" ? "sort-asc" : "sort-desc") + " active" : "")" 
                            data-sort="Department">
                            Department
                            <span class="sort-icon"></span>
                        </th>
                        <th class="sortable @(sortBy == "Date" ? (sortOrder == "asc" ? "sort-asc" : "sort-desc") + " active" : "")" 
                            data-sort="Date">
                            Date
                            <span class="sort-icon"></span>
                        </th>
                        <th class="sortable @(sortBy == "Status" ? (sortOrder == "asc" ? "sort-asc" : "sort-desc") + " active" : "")" 
                            data-sort="Status">
                            Status
                            <span class="sort-icon"></span>
                        </th>
                        <th class="sortable @(sortBy == "ClockInTime" ? (sortOrder == "asc" ? "sort-asc" : "sort-desc") + " active" : "")" 
                            data-sort="ClockInTime">
                            Check In
                            <span class="sort-icon"></span>
                        </th>
                        <th class="sortable @(sortBy == "ClockOutTime" ? (sortOrder == "asc" ? "sort-asc" : "sort-desc") + " active" : "")" 
                            data-sort="ClockOutTime">
                            Check Out
                            <span class="sort-icon"></span>
                        </th>
                        <th class="sortable @(sortBy == "WorkHours" ? (sortOrder == "asc" ? "sort-asc" : "sort-desc") + " active" : "")" 
                            data-sort="WorkHours">
                            Work Hours
                            <span class="sort-icon"></span>
                        </th>
                    </tr>
                </thead>
                    <tbody id="attendanceTableBody">
                        @if (attendanceRecords.Any())
                        {
                            @foreach (var record in attendanceRecords)
                            {
                                <tr style="border-bottom: 2px solid #D6E3F2;">
                                    <td style="font-family: 'Poppins', sans-serif; font-weight: 400; font-size: 16px; color: #5A91CB; padding: 16px 8px;">@record.Employee_ID</td>
                                    <td style="font-family: 'Poppins', sans-serif; font-weight: 400; font-size: 16px; color: #5A91CB; padding: 16px 8px;">@(record.Employee?.First_Name + " " + record.Employee?.Last_Name)</td>
                                    <td style="font-family: 'Poppins', sans-serif; font-weight: 400; font-size: 16px; color: #5A91CB; padding: 16px 8px;">@record.Employee?.Department?.Department_Name</td>
                                    <td style="font-family: 'Poppins', sans-serif; font-weight: 400; font-size: 16px; color: #5A91CB; padding: 16px 8px;">@record.Date.ToString("MMM dd, yyyy")</td>
                                    <td style="font-family: 'Poppins', sans-serif; font-weight: 400; font-size: 16px; color: #5A91CB; padding: 16px 8px;">
                                        @{
                                            var statusClass = "status-default";
                                            if (!string.IsNullOrEmpty(record.Status))
                                            {
                                                switch (record.Status.ToLower())
                                                {
                                                    case "present": statusClass = "status-present"; break;
                                                    case "absent": statusClass = "status-absent"; break;
                                                    case "late": statusClass = "status-late"; break;
                                                    case "on leave": statusClass = "status-leave"; break;
                                                    case "on time": statusClass = "status-present"; break;
                                                }
                                            }
                                        }
                                        <span class="status-badge @statusClass">@record.Status</span>
                                    </td>
                                    <td style="font-family: 'Poppins', sans-serif; font-weight: 400; font-size: 16px; color: #5A91CB; padding: 16px 8px;">@(record.ClockInTime?.ToString(@"hh\:mm") ?? "-")</td>
                                    <td style="font-family: 'Poppins', sans-serif; font-weight: 400; font-size: 16px; color: #5A91CB; padding: 16px 8px;">@(record.ClockOutTime?.ToString(@"hh\:mm") ?? "-")</td>
                                    <td style="font-family: 'Poppins', sans-serif; font-weight: 400; font-size: 16px; color: #5A91CB; padding: 16px 8px;">
                                        @{
                                            if (record.ClockInTime.HasValue && record.ClockOutTime.HasValue)
                                            {
                                                double workHours = Math.Max(0, (record.ClockOutTime.Value - record.ClockInTime.Value).TotalHours);
                                                workHours = Math.Round(workHours, 1);
                                                @($"{workHours:0.0} hrs")
                                            }
                                            else
                                            {
                                                @("-")
                                            }
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4" style="color: #5A91CB !important; font-family: 'Poppins', sans-serif;">
                                    No attendance records found
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
             <!-- Pagination and Show Entries -->
        @if (totalRecords > 0)
        {
            <div class="pagination-container">
                <!-- Left side: Status indicators and info -->
                <div class="d-flex align-items-center gap-4">
                    <!-- Pagination Info -->
                    <div class="pagination-info">
                        Showing @(((currentPage - 1) * pageSize) + 1)-@Math.Min(currentPage * pageSize, totalRecords) of @totalRecords records
                    </div>

                    <!-- Add vertical separator -->
                    <div class="vr" style="height: 20px; background-color: #D6E3F2;"></div>
                </div>

                <!-- Right side: Pagination Navigation -->
                <nav aria-label="Attendance pagination">
                    <ul class="pagination mb-0" id="paginationNav">
                        <!-- Previous button -->
                        <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                            <a class="page-link"
                               href="@Url.Action("AttendanceOverview", "Monitoring", new {
                                   searchTerm = searchTerm,
                                   dateFrom = dateFrom?.ToString("yyyy-MM-dd"),
                                   dateTo = dateTo?.ToString("yyyy-MM-dd"),
                                   sortBy = sortBy,
                                   sortOrder = sortOrder,
                                   pageSize = pageSize,
                                   currentPage = currentPage - 1
                               })"
                               aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>

                        <!-- Page numbers -->
                        @{
                            int startPage = Math.Max(1, currentPage - 2);
                            int endPage = Math.Min(totalPages, startPage + 4);

                            if (endPage - startPage < 4)
                            {
                                startPage = Math.Max(1, endPage - 4);
                            }
                        }

                        @for (int i = startPage; i <= endPage; i++)
                        {
                            <li class="page-item @(i == currentPage ? "active" : "")">
                                <a class="page-link"
                                   href="@Url.Action("AttendanceOverview", "Monitoring", new {
                                       searchTerm = searchTerm,
                                       dateFrom = dateFrom?.ToString("yyyy-MM-dd"),
                                       dateTo = dateTo?.ToString("yyyy-MM-dd"),
                                       sortBy = sortBy,
                                       sortOrder = sortOrder,
                                       pageSize = pageSize,
                                       currentPage = i
                                   })">
                                    @i
                                </a>
                            </li>
                        }

                        <!-- Next button -->
                        <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                            <a class="page-link"
                               href="@Url.Action("AttendanceOverview", "Monitoring", new {
                                   searchTerm = searchTerm,
                                   dateFrom = dateFrom?.ToString("yyyy-MM-dd"),
                                   dateTo = dateTo?.ToString("yyyy-MM-dd"),
                                   sortBy = sortBy,
                                   sortOrder = sortOrder,
                                   pageSize = pageSize,
                                   currentPage = currentPage + 1
                               })"
                               aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Debounce function to prevent too many submissions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Function to submit the form
        function submitFilterForm() {
            document.getElementById('filterForm').submit();
        }

        // Debounced version of submit for search input
        const debouncedSubmit = debounce(submitFilterForm, 500);

        // Clear search input only
        function clearSearch() {
            const searchInput = document.getElementById('searchTerm');
            if (searchInput) {
                searchInput.value = '';
                submitFilterForm();
            }
        }

        // Clear ALL filters (search and dates)
        function resetToDefaults() {
            // Simply navigate to the page without any query parameters
            window.location.href = '@Url.Action("AttendanceOverview", "Monitoring")';
        }

        function exportToExcel() {
            const exportBtn = document.getElementById('exportBtn');
            const originalHTML = exportBtn.innerHTML;
    
            // Show loading state
            exportBtn.classList.add('loading');
            exportBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';
            exportBtn.disabled = true;
    
            // Show loading message
            showMessage('Preparing Excel file for download...', 'info');
    
            // Get current filter values
            const searchTerm = document.getElementById('searchTerm')?.value || '';
            const dateFrom = document.getElementById('dateFrom')?.value || '';
            const dateTo = document.getElementById('dateTo')?.value || '';
    
            // ADDED: Get current sorting values
            const sortBy = document.getElementById('sortBy')?.value || 'Date';
            const sortOrder = document.getElementById('sortOrder')?.value || 'desc';

            // Create a hidden form
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '@Url.Action("ExportToExcel", "Monitoring")';
            form.style.display = 'none';

            // Add search term
            const searchInput = document.createElement('input');
            searchInput.type = 'hidden';
            searchInput.name = 'searchTerm';
            searchInput.value = searchTerm;
            form.appendChild(searchInput);

            // Add dateFrom
            const dateFromInput = document.createElement('input');
            dateFromInput.type = 'hidden';
            dateFromInput.name = 'dateFrom';
            dateFromInput.value = dateFrom;
            form.appendChild(dateFromInput);

            // Add dateTo
            const dateToInput = document.createElement('input');
            dateToInput.type = 'hidden';
            dateToInput.name = 'dateTo';
            dateToInput.value = dateTo;
            form.appendChild(dateToInput);

            // ADDED: Add sortBy
            const sortByInput = document.createElement('input');
            sortByInput.type = 'hidden';
            sortByInput.name = 'sortBy';
            sortByInput.value = sortBy;
            form.appendChild(sortByInput);

            // ADDED: Add sortOrder
            const sortOrderInput = document.createElement('input');
            sortOrderInput.type = 'hidden';
            sortOrderInput.name = 'sortOrder';
            sortOrderInput.value = sortOrder;
            form.appendChild(sortOrderInput);

            // Add anti-forgery token
            const token = document.querySelector('input[name="__RequestVerificationToken"]');
            if (token) {
                form.appendChild(token.cloneNode(true));
            }
    
            document.body.appendChild(form);
            form.submit();
    
            // Reset button after 5 seconds (in case download doesn't start)
            setTimeout(() => {
                exportBtn.classList.remove('loading');
                exportBtn.innerHTML = originalHTML;
                exportBtn.disabled = false;
            }, 5000);
        }

        // Function to show temporary messages
function showMessage(message, type) {
    // Remove existing messages
    const existingMessages = document.querySelectorAll('.alert-message');
    existingMessages.forEach(msg => msg.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-message`;
    alertDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="bi bi-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
            <span>${message}</span>
            <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    // Add CSS for alert if not already added
    if (!document.getElementById('alert-styles')) {
        const style = document.createElement('style');
        style.id = 'alert-styles';
        style.textContent = `
            .alert-message {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
                border: 1px solid #C6E6FB;
                box-shadow: 0px 1px 4px rgba(88, 134, 166, 0.25);
                border-radius: 8px;
            }
            
            .alert-info {
                background: #FFFFFF !important;
                border-left: 4px solid #5A91CB !important;
                color: #122539 !important;
            }
            
            .alert-success {
                background: #FFFFFF !important;
                border-left: 4px solid #28a745 !important;
                color: #122539 !important;
            }
            
            .alert-danger {
                background: #FFFFFF !important;
                border-left: 4px solid #dc3545 !important;
                color: #122539 !important;
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 5000);
}

// Back button functionality
function goBack() {
    window.location.href = '@Url.Action("Index", "Monitoring")';
}

        // Set today's date as max for Date To
        document.addEventListener('DOMContentLoaded', function() {
            const dateToInput = document.getElementById('dateTo');
            const dateFromInput = document.getElementById('dateFrom');
            const searchInput = document.getElementById('searchTerm');
            const filterForm = document.getElementById('filterForm');
            
            // Set default dates if empty
            if (dateToInput && !dateToInput.value) {
                const today = new Date().toISOString().split('T')[0];
                dateToInput.value = today;
            }
            
            if (dateFromInput && !dateFromInput.value) {
                const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1)
                    .toISOString().split('T')[0];
                dateFromInput.value = firstDayOfMonth;
            }

            // Auto-submit on date change (immediate)
            if (dateFromInput) {
                dateFromInput.addEventListener('change', function() {
                    submitFilterForm();
                });
            }

            if (dateToInput) {
                dateToInput.addEventListener('change', function() {
                    submitFilterForm();
                });
            }

            // Auto-submit on search input (with debounce)
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    debouncedSubmit();
                });
                
                // Also submit on Enter key
                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        submitFilterForm();
                    }
                });
            }

            // Add click event listeners to sortable headers
            document.querySelectorAll('th.sortable').forEach(header => {
                header.addEventListener('click', function() {
                    const sortBy = this.dataset.sort;
                    const currentSortBy = document.getElementById('sortBy').value;
                    const currentSortOrder = document.getElementById('sortOrder').value;
                    
                    let newSortOrder = 'asc';
                    
                    // If clicking the same column, toggle the order
                    if (currentSortBy === sortBy) {
                        newSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';
                    }
                    
                    // Update hidden inputs
                    document.getElementById('sortBy').value = sortBy;
                    document.getElementById('sortOrder').value = newSortOrder;
                    
                    // Submit the form
                    submitFilterForm();
                });
            });
        });

    </script>
}