@model List<Attendance>
@{
    ViewData["Title"] = "Check-In/Check-Out";
    Layout = "_Layout";

    // Get selected month/year from query string or use current
    int selectedMonth = DateTime.Now.Month;
    int selectedYear = DateTime.Now.Year;

    if (Context.Request.Query.ContainsKey("month") && int.TryParse(Context.Request.Query["month"], out int month))
    {
        selectedMonth = month;
    }
    if (Context.Request.Query.ContainsKey("year") && int.TryParse(Context.Request.Query["year"], out int year))
    {
        selectedYear = year;
    }

    var selectedDate = new DateTime(selectedYear, selectedMonth, 1);

    // Get today's attendance if exists
    var todayAttendance = Model?.FirstOrDefault(a => a.Date.Date == DateTime.Today);
    var recentAttendance = Model?.Where(a => a.Date.Date < DateTime.Today)
                                 .OrderByDescending(a => a.Date)
                                 .Take(5)
                                 .ToList();

    // Get attendance for selected month
    var monthlyAttendance = Model?.Where(a => a.Date.Month == selectedMonth && a.Date.Year == selectedYear).ToList();
}
<style>
    .simple-calendar {
        font-size: 0.8rem;
    }

    .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        text-align: center;
        font-weight: 500;
        color: #6c757d;
        margin-bottom: 5px;
        padding: 0 2px;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 3px;
    }

    .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        background-color: #f8f9fa;
        font-size: 0.75rem;
        font-weight: 500;
    }

        .calendar-day.today {
            background-color: #0d6efd;
            color: white;
            font-weight: bold;
        }

        .calendar-day.empty {
            background-color: transparent;
        }

    .summary-item-small {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }

        .summary-item-small:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

    .summary-value-small {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 5px;
        color: #0d6efd;
    }

    .summary-label-small {
        font-size: 0.8rem;
        color: #6c757d;
        font-weight: 500;
    }

    .btn-lg {
        padding: 0.75rem 1.5rem;
        font-size: 1.1rem;
    }

    .border-end {
        border-right: 1px solid #dee2e6 !important;
    }

    .analog-clock-container {
        position: relative;
        margin: 0 auto;
    }

    #analog-clock {
        display: block;
        margin: 0 auto;
    }

    svg {
        display: block;
    }

    .h-100 {
        height: 100%;
    }

    .card {
        min-height: 0;
    }
    /* Add to your existing CSS */
    .summary-box {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }

        .summary-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

    .summary-title {
        font-size: 0.9rem;
        color: #6c757d;
        font-weight: 600;
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .summary-time {
        font-size: 1.2rem;
        font-weight: 700;
        color: #0d6efd;
        font-family: 'Courier New', monospace;
    }

    .d-grid {
        display: grid;
    }

    .gap-3 {
        gap: 1rem;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header Section -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Check-In & Check-Out</h1>
                <div class="d-flex align-items-center">
                    <!-- Month Dropdown -->
                    <select class="form-select form-select-sm me-2" id="monthSelect" style="min-width: 120px;">
                        @{
                            var monthNames = new[] { "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" };
                        }
                        @for (int i = 0; i < monthNames.Length; i++)
                        {
                            if (selectedMonth == i + 1)
                            {
                                <option value="@(i + 1)" selected>@monthNames[i]</option>
                            }
                            else
                            {
                                <option value="@(i + 1)">@monthNames[i]</option>
                            }
                        }
                    </select>

                    <!-- Year Dropdown -->
                    <select class="form-select form-select-sm" id="yearSelect" style="min-width: 100px;">
                        @for (int y = DateTime.Now.Year - 5; y <= DateTime.Now.Year + 1; y++)
                        {
                            if (y == selectedYear)
                            {
                                <option value="@y" selected>@y</option>
                            }
                            else
                            {
                                <option value="@y">@y</option>
                            }
                        }
                    </select>
                </div>
            </div>

            <!-- Current Status Card -->
            <div class="row mb-4">
                <!-- Left Side - Calendar -->
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body p-3">
                            <h6 class="card-title mb-3">
                                <span id="calendarMonthYear">@selectedDate.ToString("MMMM yyyy")</span>
                            </h6>

                            <!-- Simple calendar grid -->
                            <div class="simple-calendar">
                                <div class="calendar-header">
                                    <div class="text-muted">S</div>
                                    <div class="text-muted">M</div>
                                    <div class="text-muted">T</div>
                                    <div class="text-muted">W</div>
                                    <div class="text-muted">T</div>
                                    <div class="text-muted">F</div>
                                    <div class="text-muted">S</div>
                                </div>
                                <div class="calendar-grid">
                                    @{
                                        var firstDay = new DateTime(selectedYear, selectedMonth, 1);
                                        var daysInMonth = DateTime.DaysInMonth(selectedYear, selectedMonth);
                                        var startDay = (int)firstDay.DayOfWeek;
                                    }

                                    @for (int i = 0; i < startDay; i++)
                                    {
                                        <div class="calendar-day empty"></div>
                                    }

                                    @for (int day = 1; day <= daysInMonth; day++)
                                    {
                                        var dayDate = new DateTime(selectedYear, selectedMonth, day);
                                        var isToday = dayDate.Date == DateTime.Today;
                                        var dayClass = "calendar-day";

                                        if (isToday)
                                        {
                                            dayClass += " today";
                                        }

                                        <div class="@dayClass">
                                            @day
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Side - Clock & Break Management -->
                <div class="col-md-8">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <div class="row h-100">
                                <!-- Left column: Analog clock -->
                                <div class="col-md-6 border-end">
                                    <div class="d-flex flex-column justify-content-center align-items-center h-100">
                                        <!-- Analog Clock Container -->
                                        <div class="text-center mb-4">
                                            <div class="analog-clock-container" style="position: relative; width: 220px; height: 220px; margin: 0 auto;">
                                                <svg width="220" height="220" viewBox="0 0 200 200" id="analog-clock">
                                                    <!-- Clock face - Light blue theme -->
                                                    <circle cx="100" cy="100" r="95" fill="#f8fafc" stroke="#7dd3fc" stroke-width="4" />

                                                    <!-- Hour marks will be added by JavaScript -->
                                                    <g id="hour-marks"></g>

                                                    <!-- Hour numbers will be added by JavaScript -->
                                                    <g id="hour-numbers" font-family="Arial" font-size="16" fill="#475569" text-anchor="middle" alignment-baseline="middle"></g>

                                                    <!-- Clock hands - Light blue theme -->
                                                    <line id="hour-hand" x1="100" y1="100" x2="100" y2="60" stroke="#64748b" stroke-width="6" stroke-linecap="round" />
                                                    <line id="minute-hand" x1="100" y1="100" x2="100" y2="40" stroke="#38bdf8" stroke-width="4" stroke-linecap="round" />
                                                    <line id="second-hand" x1="100" y1="100" x2="100" y2="30" stroke="#f87171" stroke-width="2" stroke-linecap="round" />

                                                    <!-- Clock center dot -->
                                                    <circle cx="100" cy="100" r="6" fill="#38bdf8" />
                                                </svg>
                                            </div>

                                            <!-- Digital time display below clock -->
                                            <div style="font-size: 1.8rem; font-weight: bold; color: #38bdf8; margin-top: 15px; font-family: 'Courier New', monospace;">
                                                <span id="digital-time">@DateTime.Now.ToString("hh:mm:ss")</span>
                                                <span style="font-size: 1rem; color: #94a3b8; margin-left: 5px;" id="am-pm">@DateTime.Now.ToString("tt").ToUpper()</span>
                                            </div>

                                            <!-- Date display -->
                                            <div style="font-size: 1.2rem; color: #475569; margin-top: 5px;">
                                                <span id="liveDateShort">@DateTime.Now.ToString("dddd, MMMM dd")</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right column: Hours Summary & Check buttons -->
                                <div class="col-md-6">
                                    <div class="d-flex flex-column justify-content-center h-100">
                                        <!-- Hours Summary (Vertical format) -->
                                        <div class="mb-4">
                                            <div class="text-center">
                                                <div class="d-grid gap-3">
                                                    <!-- Working Hours -->
                                                    <div class="summary-box">
                                                        <div class="summary-title">Working Hours</div>
                                                        <div class="summary-time" id="workingTime">
                                                            <span id="workingHours">0</span> Hr
                                                            <span id="workingMinutes">00</span> Mins
                                                            <span id="workingSeconds">00</span> Secs
                                                        </div>
                                                    </div>

                                                    <!-- Break Hours -->
                                                    <div class="summary-box">
                                                        <div class="summary-title">Break Hours</div>
                                                        <div class="summary-time" id="breakTime">
                                                            <span id="breakHours">0</span> Hr
                                                            <span id="breakMinutes">00</span> Mins
                                                            <span id="breakSeconds">00</span> Secs
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Check In/Out Button -->
                                        <div class="mt-4">
                                            <div class="text-center">
                                                @if (todayAttendance?.ClockInTime == null)
                                                {
                                                    <form asp-action="ClockIn" method="post" id="clockInForm">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="btn btn-success btn-lg w-100 py-3" id="clockInBtn">
                                                            <h4 class="mb-1">Check In</h4>
                                                            <small class="text-white-50">Start your workday</small>
                                                        </button>
                                                    </form>
                                                }
                                                else if (todayAttendance?.ClockOutTime == null)
                                                {
                                                    <form asp-action="ClockOut" method="post" id="clockOutForm">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="btn btn-danger btn-lg w-100 py-3" id="clockOutBtn">
                                                            <h4 class="mb-1">Check Out</h4>
                                                            <small class="text-white-50">End your workday</small>
                                                        </button>
                                                        <div class="mt-2">
                                                            <small class="text-muted">
                                                                Clocked in at: @TimeSpanToString(todayAttendance.ClockInTime)
                                                            </small>
                                                        </div>
                                                    </form>
                                                }
                                                else
                                                {
                                                    <div class="alert alert-success">
                                                        <h5>Day Completed!</h5>
                                                        <p class="mb-0">
                                                            Checked in: @TimeSpanToString(todayAttendance.ClockInTime)<br>
                                                            Checked out: @TimeSpanToString(todayAttendance.ClockOutTime.Value)
                                                        </p>
                                                    </div>
                                                }
                                            </div>
                                        </div>


                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="row">
                    <div class="col-12">
                        <div class="card shadow-sm border-0">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">Recent Attendance</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Time In</th>
                                                <th>Time Out</th>
                                                <th>Break Hours</th>
                                                <th>Working Hours</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @if (recentAttendance != null && recentAttendance.Any())
                                            {
                                                @foreach (var record in recentAttendance)
                                                {
                                                    <tr>
                                                        <td>@record.Date.ToString("MMM dd, yyyy")</td>
                                                        <td>
                                                            @if (record.ClockInTime != null)
                                                            {
                                                                <span>@TimeSpanToString(record.ClockInTime)</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">-</span>
                                                            }
                                                        </td>
                                                        <td>
                                                            @if (record.ClockOutTime != null)
                                                            {
                                                                <span>@TimeSpanToString(record.ClockOutTime.Value)</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">-</span>
                                                            }
                                                        </td>
                                                        <td>
                                                            <span>1.00</span>
                                                        </td>
                                                        <td>
                                                            @if (record.ClockInTime != null && record.ClockOutTime != null)
                                                            {
                                                                var totalHours = (record.ClockOutTime.Value - record.ClockInTime).TotalHours;
                                                                var workingHours = totalHours - 1.0;
                                                                <span>@workingHours.ToString("F2")</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="text-muted">-</span>
                                                            }
                                                        </td>
                                                    </tr>
                                                }
                                            }
                                            else
                                            {
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted py-4">
                                                        No attendance records found
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

@section Scripts {
        <script>
            // Global variables for timers
            let workingTimer = null;
            let breakTimer = null;
            let workingSeconds = 0;
            let breakSeconds = 0;

            document.addEventListener('DOMContentLoaded', function() {
                // Initialize clock face
                initializeClockFace();

                // Start analog clock
                updateAnalogClock();
                setInterval(updateAnalogClock, 50);

                // Live clock update for check-in time
                function updateTime() {
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('en-US', {
                        hour12: true,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    if (document.getElementById('checkInTime')) {
                        document.getElementById('checkInTime').textContent = timeString;
                    }
                }
                setInterval(updateTime, 1000);
                updateTime();

                // Initialize time displays
                initializeTimeDisplays();

                // Get dropdown elements
                const monthSelect = document.getElementById('monthSelect');
                const yearSelect = document.getElementById('yearSelect');

                // Set initial values from selected month/year
                if (monthSelect && yearSelect) {
                    monthSelect.value = @selectedMonth;
                    yearSelect.value = @selectedYear;
                }

                // Auto-apply when either dropdown changes
                function applyMonthYear() {
                    const newYear = yearSelect.value;
                    const newMonth = monthSelect.value;

                    // Update the calendar header text
                    const monthYearElement = document.getElementById('calendarMonthYear');
                    if (monthYearElement) {
                        const date = new Date(newYear, newMonth - 1);
                        monthYearElement.textContent =
                            date.toLocaleString('default', {
                                month: 'long',
                                year: 'numeric'
                            });
                    }

                    // Reload the page with new parameters
                    window.location.href = `?month=${newMonth}&year=${newYear}`;
                }

                // Add event listeners
                if (monthSelect) {
                    monthSelect.addEventListener('change', applyMonthYear);
                }

                if (yearSelect) {
                    yearSelect.addEventListener('change', applyMonthYear);
                }

                // Prevent double submission for clock in/out
                const clockInBtn = document.getElementById('clockInBtn');
                const clockOutBtn = document.getElementById('clockOutBtn');

                if (clockInBtn) {
                    clockInBtn.addEventListener('click', function(e) {
                        this.disabled = true;
                        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Clocking in...';
                    });
                }

                if (clockOutBtn) {
                    clockOutBtn.addEventListener('click', function(e) {
                        this.disabled = true;
                        this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Clocking out...';

                        // Stop all timers when clocking out
                        stopWorkingTimer();
                        stopBreakTimer();
                    });
                }

                // Break button functionality
                const startBreakBtn = document.getElementById('startBreakBtn');
                const endBreakBtn = document.getElementById('endBreakBtn');
                const breakStatus = document.getElementById('breakStatus');

                if (startBreakBtn) {
                    startBreakBtn.addEventListener('click', function() {
                        this.disabled = true;
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-primary');
                        this.innerHTML = 'Break Active';

                        if (endBreakBtn) {
                            endBreakBtn.disabled = false;
                            endBreakBtn.classList.remove('btn-outline-danger');
                            endBreakBtn.classList.add('btn-danger');
                        }

                        if (breakStatus) {
                            breakStatus.innerHTML = 'Break started at ' + new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        }

                        startBreakTimer();
                    });
                }

                if (endBreakBtn) {
                    endBreakBtn.addEventListener('click', function() {
                        this.disabled = true;
                        this.classList.remove('btn-danger');
                        this.classList.add('btn-outline-danger');
                        this.innerHTML = 'End Break';

                        if (startBreakBtn) {
                            startBreakBtn.disabled = false;
                            startBreakBtn.classList.remove('btn-primary');
                            startBreakBtn.classList.add('btn-outline-primary');
                            startBreakBtn.innerHTML = 'Start Break';
                        }

                        if (breakStatus) {
                            breakStatus.innerHTML = 'No active break';
                        }

                        stopBreakTimer();
                    });
                }
            });

            // ========== CLOCK FACE FUNCTIONS ==========
            function initializeClockFace() {
                const hourMarks = document.getElementById('hour-marks');
                const hourNumbers = document.getElementById('hour-numbers');

                if (!hourMarks || !hourNumbers) return;

                // Clear any existing content
                hourMarks.innerHTML = '';
                hourNumbers.innerHTML = '';

                // Create hour marks and numbers
                for (let i = 0; i < 12; i++) {
                    const angle = i * 30;
                    const rad = (angle - 90) * Math.PI / 180;

                    // Create hour mark line
                    const x1 = 100 + 85 * Math.cos(rad);
                    const y1 = 100 + 85 * Math.sin(rad);
                    const x2 = 100 + 95 * Math.cos(rad);
                    const y2 = 100 + 95 * Math.sin(rad);

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x1);
                    line.setAttribute('y1', y1);
                    line.setAttribute('x2', x2);
                    line.setAttribute('y2', y2);
                    line.setAttribute('stroke', '#7dd3fc');
                    line.setAttribute('stroke-width', '3');
                    hourMarks.appendChild(line);

                    // Create hour number
                    const hourNum = i === 0 ? 12 : i;
                    const numberX = 100 + 70 * Math.cos(rad);
                    const numberY = 100 + 70 * Math.sin(rad);

                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', numberX);
                    text.setAttribute('y', numberY);
                    text.textContent = hourNum.toString();
                    hourNumbers.appendChild(text);
                }
            }

            function updateAnalogClock() {
                const now = new Date();
                const hours = now.getHours() % 12;
                const minutes = now.getMinutes();
                const seconds = now.getSeconds();
                const milliseconds = now.getMilliseconds();

                // Calculate angles
                const secondAngle = (seconds + milliseconds / 1000) * 6;
                const minuteAngle = (minutes + seconds / 60) * 6;
                const hourAngle = (hours + minutes / 60) * 30;

                // Apply rotation
                const hourHand = document.getElementById('hour-hand');
                const minuteHand = document.getElementById('minute-hand');
                const secondHand = document.getElementById('second-hand');

                if (hourHand) hourHand.setAttribute('transform', `rotate(${hourAngle}, 100, 100)`);
                if (minuteHand) minuteHand.setAttribute('transform', `rotate(${minuteAngle}, 100, 100)`);
                if (secondHand) secondHand.setAttribute('transform', `rotate(${secondAngle}, 100, 100)`);

                // Update digital display
                const digitalTime = document.getElementById('digital-time');
                const amPm = document.getElementById('am-pm');
                const dateElement = document.getElementById('liveDateShort');

                if (digitalTime) {
                    const timeString = now.toLocaleTimeString('en-US', {
                        hour12: true,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                    digitalTime.textContent = timeString.replace(/ AM| PM/, '');
                }

                if (amPm) {
                    amPm.textContent = now.getHours() >= 12 ? 'PM' : 'AM';
                }

                if (dateElement) {
                    const dateString = now.toLocaleDateString('en-US', {
                        weekday: 'long',
                        month: 'long',
                        day: 'numeric'
                    });
                    dateElement.textContent = dateString;
                }
            }

            // ========== TIMER FUNCTIONS ==========
            function startWorkingTimer() {
                if (workingTimer) return;

                workingTimer = setInterval(function() {
                    workingSeconds++;
                    updateWorkingTimeDisplay();
                }, 1000);
            }

            function stopWorkingTimer() {
                if (workingTimer) {
                    clearInterval(workingTimer);
                    workingTimer = null;
                }
            }

            function startBreakTimer() {
                if (breakTimer) return;

                // Pause working timer when break starts
                stopWorkingTimer();

                breakTimer = setInterval(function() {
                    breakSeconds++;
                    updateBreakTimeDisplay();
                }, 1000);
            }

            function stopBreakTimer() {
                if (breakTimer) {
                    clearInterval(breakTimer);
                    breakTimer = null;
                }

                // Resume working timer when break ends (if user is still checked in)
                const clockInBtn = document.getElementById('clockInBtn');
                const clockOutBtn = document.getElementById('clockOutBtn');

                if (!workingTimer && !clockInBtn && clockOutBtn) {
                    startWorkingTimer();
                }
            }

            function updateWorkingTimeDisplay() {
                const hours = Math.floor(workingSeconds / 3600);
                const minutes = Math.floor((workingSeconds % 3600) / 60);
                const seconds = workingSeconds % 60;

                const workingHoursEl = document.getElementById('workingHours');
                const workingMinutesEl = document.getElementById('workingMinutes');
                const workingSecondsEl = document.getElementById('workingSeconds');

                if (workingHoursEl) workingHoursEl.textContent = hours;
                if (workingMinutesEl) workingMinutesEl.textContent = minutes.toString().padStart(2, '0');
                if (workingSecondsEl) workingSecondsEl.textContent = seconds.toString().padStart(2, '0');
            }

            function updateBreakTimeDisplay() {
                const hours = Math.floor(breakSeconds / 3600);
                const minutes = Math.floor((breakSeconds % 3600) / 60);
                const seconds = breakSeconds % 60;

                const breakHoursEl = document.getElementById('breakHours');
                const breakMinutesEl = document.getElementById('breakMinutes');
                const breakSecondsEl = document.getElementById('breakSeconds');

                if (breakHoursEl) breakHoursEl.textContent = hours;
                if (breakMinutesEl) breakMinutesEl.textContent = minutes.toString().padStart(2, '0');
                if (breakSecondsEl) breakSecondsEl.textContent = seconds.toString().padStart(2, '0');
            }

            function initializeTimeDisplays() {
                // If user is already clocked in today, calculate elapsed time
                @if (todayAttendance?.ClockInTime != null && todayAttendance?.ClockOutTime == null)
                {
                            <text>
                            try {
                                const now = new Date();
                                const todayStr = now.toISOString().split('T')[0];
                                const clockInTimeStr = '@todayAttendance.ClockInTime.ToString(@"hh\:mm\:ss")';
                                const clockInDateTime = new Date(todayStr + 'T' + clockInTimeStr);

                                if (!isNaN(clockInDateTime.getTime())) {
                                    const elapsedSeconds = Math.floor((now - clockInDateTime) / 1000);
                                    workingSeconds = Math.max(0, elapsedSeconds);
                                    startWorkingTimer();
                                }
                            } catch (e) {
                                console.error('Error calculating elapsed time:', e);
                            }
                            </text>
                }
                else if (todayAttendance?.ClockOutTime != null)
                {
                            <text>
                            try {
                                const todayStr = '@DateTime.Today.ToString("yyyy-MM-dd")';
                                const clockInTimeStr = '@todayAttendance.ClockInTime.ToString(@"hh\:mm\:ss")';
                                const clockOutTimeStr = '@todayAttendance.ClockOutTime.Value.ToString(@"hh\:mm\:ss")';

                                const clockInDateTime = new Date(todayStr + 'T' + clockInTimeStr);
                                const clockOutDateTime = new Date(todayStr + 'T' + clockOutTimeStr);

                                if (!isNaN(clockInDateTime.getTime()) && !isNaN(clockOutDateTime.getTime())) {
                                    const totalSeconds = Math.floor((clockOutDateTime - clockInDateTime) / 1000);
                                    workingSeconds = Math.max(0, totalSeconds);
                                    updateWorkingTimeDisplay();
                                }
                            } catch (e) {
                                console.error('Error calculating completed time:', e);
                            }
                            </text>
                }

                updateWorkingTimeDisplay();
                updateBreakTimeDisplay();
            }
        </script>
}

@functions {
    // Helper function to format TimeSpan
    public string TimeSpanToString(TimeSpan time)
    {
        var dateTime = DateTime.Today.Add(time);
        return dateTime.ToString("hh:mm tt");
    }

    // Helper function for status badge classes
    public string GetStatusBadgeClass(string status)
    {
        return status?.ToLower() switch
        {
            "present" => "bg-success",
            "late" => "bg-warning",
            "absent" => "bg-danger",
            "half day" => "bg-info",
            "on leave" => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    // Make this a regular function that accepts parameters
    public int GetWorkingDaysInMonth(int year, int month)
    {
        int workingDays = 0;
        var daysInMonth = DateTime.DaysInMonth(year, month);

        for (int day = 1; day <= daysInMonth; day++)
        {
            var currentDate = new DateTime(year, month, day);
            if (currentDate.DayOfWeek != DayOfWeek.Saturday && currentDate.DayOfWeek != DayOfWeek.Sunday)
            {
                workingDays++;
            }
        }

        return workingDays;
    }
}
