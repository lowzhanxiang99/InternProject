@model List<Attendance>
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show">
        <i class="bi bi-check-circle-fill me-2"></i>
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Warning"] != null)
{
    <div class="alert alert-warning alert-dismissible fade show">
        <i class="bi bi-exclamation-triangle-fill me-2"></i>
        @TempData["Warning"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show">
        <i class="bi bi-x-circle-fill me-2"></i>
        @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@{
    ViewData["Title"] = "Check-In/Check-Out";
    Layout = "_Layout";

    // Get selected month/year from query string or use current
    int selectedMonth = DateTime.Now.Month;
    int selectedYear = DateTime.Now.Year;

    if (Context.Request.Query.ContainsKey("month") && int.TryParse(Context.Request.Query["month"], out int month))
    {
        selectedMonth = month;
    }
    if (Context.Request.Query.ContainsKey("year") && int.TryParse(Context.Request.Query["year"], out int year))
    {
        selectedYear = year;
    }

    var selectedDate = new DateTime(selectedYear, selectedMonth, 1);

    // Get today's attendance if exists
    var todayAttendance = Model?.FirstOrDefault(a => a.Date.Date == DateTime.Today);

    // Pagination settings for recent attendance
    int pageSize = 10; // Number of records per page
    int currentPage = 1;
    if (Context.Request.Query.ContainsKey("page") && int.TryParse(Context.Request.Query["page"], out int page))
    {
        currentPage = page;
    }

    // Get all past attendance records
    var allPastAttendance = Model?.OrderByDescending(a => a.Date).ToList();

    // Apply pagination
    var totalRecords = allPastAttendance?.Count ?? 0;
    var totalPages = (int)Math.Ceiling((double)totalRecords / pageSize);

    // Ensure current page is valid
    if (currentPage < 1) currentPage = 1;
    if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;

    // Get paginated recent attendance
    var recentAttendance = allPastAttendance?
        .Skip((currentPage - 1) * pageSize)
        .Take(pageSize)
        .ToList();

    // Helper functions inside the main block
    Attendance GetAttendanceForDay(int day)
    {
        if (Model == null) return null;
        var date = new DateTime(selectedYear, selectedMonth, day);
        return Model.FirstOrDefault(a => a.Date.Date == date.Date);
    }

    string GetAttendanceClass(Attendance attendance)
    {
        if (attendance == null) return "no-attendance";

        // Use the actual status from database
        if (!string.IsNullOrEmpty(attendance.Status))
        {
            string status = attendance.Status.ToLower();

            // Check if both clock in and clock out exist
            bool isCompleted = attendance.ClockInTime != null && attendance.ClockOutTime != null;

            if (status == "on time")
            {
                return isCompleted ? "completed-on-time" : "incomplete-on-time";
            }
            else if (status == "late")
            {
                return isCompleted ? "completed-late" : "incomplete-late";
            }
        }

        // Fallback for "absent" or no status
        if (attendance.ClockInTime != null && attendance.ClockOutTime != null)
            return "completed";
        if (attendance.ClockInTime != null)
            return "incomplete";

        return "absent";
    }

    string GetAttendanceTooltip(Attendance attendance, DateTime date)
    {
        if (attendance == null)
            return $"{date:MMM dd}: No attendance record";

        if (attendance.ClockInTime != null && attendance.ClockOutTime != null)
            return $"{date:MMM dd}: {TimeSpanToString(attendance.ClockInTime)} - {TimeSpanToString(attendance.ClockOutTime)}";

        if (attendance.ClockInTime != null)
            return $"{date:MMM dd}: Clocked in at {TimeSpanToString(attendance.ClockInTime)}";

        return $"{date:MMM dd}: Marked absent";
    }
}

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<link rel="stylesheet" href="~/css/attendance.css" />
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header Section -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Check-In & Check-Out</h1>
            </div>

            <!-- Current Status Card -->
            <div class="row mb-4">
                <!-- Left Side - Calendar -->
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body p-3">
                            <!-- Calendar Header with Navigation -->
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <button class="btn btn-sm btn-outline-primary" id="prevMonth" title="Previous Month">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <h6 class="mb-0" id="calendarMonthYear" style="cursor: pointer;" title="Click to select month/year">
                                    @selectedDate.ToString("MMMM yyyy")
                                </h6>
                                <button class="btn btn-sm btn-outline-primary" id="nextMonth" title="Next Month">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>

                            <!-- Simple calendar grid -->
                            <div class="simple-calendar">
                                <div class="calendar-header">
                                    <div class="text-muted">S</div>
                                    <div class="text-muted">M</div>
                                    <div class="text-muted">T</div>
                                    <div class="text-muted">W</div>
                                    <div class="text-muted">T</div>
                                    <div class="text-muted">F</div>
                                    <div class="text-muted">S</div>
                                </div>
                                <!-- Calendar Grid -->
                                <div class="calendar-grid">
                                    @{
                                        var firstDay = new DateTime(selectedYear, selectedMonth, 1);
                                        var daysInMonth = DateTime.DaysInMonth(selectedYear, selectedMonth);
                                        var startDay = (int)firstDay.DayOfWeek;
                                    }

                                    @for (int i = 0; i < startDay; i++)
                                    {
                                        <div class="calendar-day empty"></div>
                                    }

                                    @for (int day = 1; day <= daysInMonth; day++)
                                    {
                                        var dayDate = new DateTime(selectedYear, selectedMonth, day);
                                        var isToday = dayDate.Date == DateTime.Today;
                                        var attendance = GetAttendanceForDay(day);
                                        var attendanceClass = GetAttendanceClass(attendance);
                                        var tooltip = GetAttendanceTooltip(attendance, dayDate);

                                        var dayClass = $"calendar-day {attendanceClass}";

                                        if (isToday)
                                        {
                                            dayClass += " today";
                                        }

                                        <div class="@dayClass"
                                             data-date="@dayDate.ToString("yyyy-MM-dd")"
                                             data-attendance-id="@attendance?.Attendance_ID"
                                             title="@tooltip"
                                             onclick="showAttendanceDetails(this)">
                                            @day
                                            @if (attendance != null)
                                            {
                                                <div class="attendance-indicator">
                                                    @if (attendance.ClockInTime != null && attendance.ClockOutTime != null)
                                                    {
                                                        <i class="bi bi-check-circle"></i>
                                                    }
                                                    else if (attendance.ClockInTime != null)
                                                    {
                                                        <i class="bi bi-clock"></i>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Side - Clock & Break Management -->
                <div class="col-md-8">
                    <div class="card shadow-sm border-0 h-100">
                        <div class="card-body">
                            <div class="row h-100">
                                <!-- Left column: Analog clock (40%) -->
                                <div class="col-md-4 border-end">
                                    <div class="d-flex flex-column justify-content-center align-items-center h-100">
                                        <!-- Analog Clock Container -->
                                        <div class="text-center mb-4">
                                            <div class="analog-clock-container">
                                                <svg id="analog-clock">
                                                    <!-- Clock face - Light blue theme -->
                                                    <circle cx="100" cy="100" r="95" fill="#f8fafc" stroke="#7dd3fc" stroke-width="4" />
                                                    <!-- Hour marks will be added by JavaScript -->
                                                    <g id="hour-marks"></g>
                                                    <!-- Hour numbers will be added by JavaScript -->
                                                    <g id="hour-numbers" font-family="Arial" font-size="16" fill="#475569" text-anchor="middle" alignment-baseline="middle"></g>
                                                    <!-- Clock hands - Light blue theme -->
                                                    <line id="hour-hand" x1="100" y1="100" x2="100" y2="60" stroke="#64748b" stroke-width="6" stroke-linecap="round" />
                                                    <line id="minute-hand" x1="100" y1="100" x2="100" y2="40" stroke="#38bdf8" stroke-width="4" stroke-linecap="round" />
                                                    <line id="second-hand" x1="100" y1="100" x2="100" y2="30" stroke="#f87171" stroke-width="2" stroke-linecap="round" />
                                                    <!-- Clock center dot -->
                                                    <circle cx="100" cy="100" r="6" fill="#38bdf8" />
                                                </svg>
                                            </div>

                                            <!-- Digital time display below clock -->
                                            <div class="digital-time-display">
                                                <span id="digital-time">@DateTime.Now.ToString("hh:mm:ss")</span>
                                                <span id="am-pm">@DateTime.Now.ToString("tt").ToUpper()</span>
                                            </div>

                                            <!-- Date display -->
                                            <div class="date-display">
                                                <span id="liveDateShort">@DateTime.Now.ToString("dddd, MMMM dd")</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right column: Hours Summary & Check buttons (60%) -->
                                <div class="col-md-8">
                                    <div class="d-flex flex-column justify-content-center h-100">
                                        <!-- Hours Summary (Vertical format) -->
                                        <div class="summary-section">
                                            <div class="text-center">
                                                <div class="d-grid gap-3">
                                                    <!-- Working Hours -->
                                                    <div class="summary-box">
                                                        <div class="summary-title">Working Hours</div>
                                                        <div class="summary-time" id="workingTime">
                                                            <span id="workingHours">0</span> Hr
                                                            <span id="workingMinutes">00</span> Mins
                                                            <span id="workingSeconds">00</span> Secs
                                                        </div>
                                                    </div>

                                                    <!-- Break Hours -->
                                                    <div class="summary-box">
                                                        <div class="summary-title">Break Hours</div>
                                                        <div class="summary-time" id="breakTime">
                                                            <span id="breakHours">0</span> Hr
                                                            <span id="breakMinutes">00</span> Mins
                                                            <span id="breakSeconds">00</span> Secs
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Dynamic Button Section -->
                                        <div class="mt-4" id="buttonSection">
                                            @if (todayAttendance?.ClockInTime == null)
                                            {
                                                <!-- Check In Button -->
                                                <form asp-action="ClockIn" method="post" id="clockInForm">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="latitude" id="clockInLat" />
                                                    <input type="hidden" name="longitude" id="clockInLng" />
                                                    <button type="submit" class="btn btn-success btn-lg w-100 py-3" id="clockInBtn">
                                                        <h4 class="mb-1">Check In</h4>
                                                        <small class="text-white-50">Start your workday</small>
                                                    </button>
                                                </form>
                                            }
                                            else if (todayAttendance?.ClockOutTime == null)
                                            {
                                                @if (!(todayAttendance?.IsOnBreak ?? false) && !(todayAttendance?.HasTakenBreak ?? false))
                                                {
                                                    <!-- Checked in, not on break, hasn't taken break: Show Start Break and Check Out -->
                                                    <form asp-action="StartBreak" method="post" id="startBreakForm" class="mb-3">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="btn btn-outline-primary btn-lg w-100 py-3" id="startBreakBtn">
                                                            <h4 class="mb-1">Start Break</h4>
                                                            <small class="text-muted">Take a break from work</small>
                                                        </button>
                                                    </form>

                                                    <form asp-action="ClockOut" method="post" id="clockOutForm">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="latitude" id="clockOutLat" />
                                                        <input type="hidden" name="longitude" id="clockOutLng" />
                                                        <button type="submit" class="btn btn-danger btn-lg w-100 py-3" id="clockOutBtn">
                                                            <h4 class="mb-1">Check Out</h4>
                                                            <small class="text-white-50">End your workday</small>
                                                        </button>
                                                    </form>
                                                    <div class="mt-2 text-center">
                                                        <small class="text-muted">
                                                            Clocked in at: @TimeSpanToString(todayAttendance.ClockInTime.Value)
                                                        </small>
                                                    </div>
                                                }
                                                else if (todayAttendance?.IsOnBreak ?? false)
                                                {
                                                    <!-- On break: Show ONLY End Break -->
                                                    <form asp-action="EndBreak" method="post" id="endBreakForm">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="btn btn-danger btn-lg w-100 py-3" id="endBreakBtn">
                                                            <h4 class="mb-1">End Break</h4>
                                                            <small class="text-white-50">Resume work</small>
                                                        </button>
                                                    </form>

                                                    <div class="alert alert-warning mt-3" id="breakStatusAlert">
                                                        <div class="d-flex align-items-center">
                                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                                            <div>
                                                                <strong>On Break</strong>
                                                                <div class="small">
                                                                    Break started at:
                                                                    <span id="breakStartTime">
                                                                        @if (todayAttendance?.BreakStartTime != null)
                                                                        {
                                                                            @DateTimeToTimeString(todayAttendance.BreakStartTime)
                                                                        }
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                }
                                                else
                                                {
                                                    <!-- After ending break (HasTakenBreak = true): Show ONLY Check Out -->
                                                    <form asp-action="ClockOut" method="post" id="clockOutForm">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="latitude" id="clockOutLat" />
                                                        <input type="hidden" name="longitude" id="clockOutLng" />
                                                        <button type="submit" class="btn btn-danger btn-lg w-100 py-3" id="clockOutBtn">
                                                            <h4 class="mb-1">Check Out</h4>
                                                            <small class="text-white-50">End your workday</small>
                                                        </button>
                                                    </form>
                                                    <div class="mt-2 text-center">
                                                        <small class="text-muted">
                                                            Clocked in at: @TimeSpanToString(todayAttendance.ClockInTime.Value)<br>
                                                            Break taken for today
                                                        </small>
                                                    </div>
                                                }
                                            }
                                            else
                                            {
                                                <!-- Day Completed -->
                                                <div class="alert alert-success">
                                                    <h5>Day Completed!</h5>
                                                    <p class="mb-0">
                                                        Checked in: @TimeSpanToString(todayAttendance.ClockInTime.Value)<br>
                                                        Checked out: @TimeSpanToString(todayAttendance.ClockOutTime.Value)<br>
                                                    </p>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Recent Attendance</h5>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <div class="table-responsive">
                                <table class="table table-hover" id="attendanceTable">
                                    <thead>
                                        <tr>
                                            <th class="sortable" data-sort="date" data-order="desc">Date</th>
                                            <th class="sortable" data-sort="timeIn" data-order="desc">Time In</th>
                                            <th class="sortable" data-sort="timeOut" data-order="desc">Time Out</th>
                                            <th class="sortable" data-sort="breakHours" data-order="desc">Break Hours</th>
                                            <th class="sortable" data-sort="workingHours" data-order="desc">Working Hours</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendanceTableBody">
                                        @if (recentAttendance != null && recentAttendance.Any())
                                        {
                                            @foreach (var record in recentAttendance)
                                            {
                                                bool isCompleted = record.ClockInTime != null && record.ClockOutTime != null;

                                                // Determine status based on clock-in time
                                                string statusClass = "";
                                                string statusText = "";

                                                if (!string.IsNullOrEmpty(record.Status))
                                                {
                                                    string status = record.Status.ToLower();

                                                    switch (status)
                                                    {
                                                        case "on time":
                                                        case "present":
                                                            statusClass = "status-on-time";
                                                            statusText = "On Time";
                                                            break;
                                                        case "late":
                                                            statusClass = "status-late";
                                                            statusText = "Late";
                                                            break;
                                                        case "absent":
                                                            statusClass = "status-absent";
                                                            statusText = "Absent";
                                                            break;
                                                        default:
                                                            statusClass = "status-on-time";
                                                            statusText = record.Status;
                                                            break;
                                                    }
                                                }
                                                else if (record.ClockInTime.HasValue)
                                                {
                                                    statusClass = "status-on-time";
                                                    statusText = "Present";
                                                }

                                                <tr data-date="@record.Date.ToString("yyyy-MM-dd")"
                                                    data-time-in="@(record.ClockInTime?.ToString(@"hh\:mm\:ss") ?? "")"
                                                    data-time-out="@(record.ClockOutTime?.ToString(@"hh\:mm\:ss") ?? "")"
                                                    data-break-hours="@(record.TotalBreakTime?.TotalSeconds ?? 0)"
                                                    data-working-hours="@((record.ClockInTime.HasValue && record.ClockOutTime.HasValue ? (record.ClockOutTime.Value - record.ClockInTime.Value - (record.TotalBreakTime ?? TimeSpan.Zero)).TotalSeconds : 0))">
                                                    <td>@record.Date.ToString("MMM dd, yyyy")</td>
                                                    <td>
                                                        @if (record.ClockInTime != null)
                                                        {
                                                            <div class="d-flex align-items-center">
                                                                @if (!string.IsNullOrEmpty(statusClass))
                                                                {
                                                                    <span class="status-indicator @statusClass me-2" title="@statusText"></span>
                                                                }
                                                                <span>@TimeSpanToString(record.ClockInTime.Value)</span>
                                                            </div>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (record.ClockOutTime != null)
                                                        {
                                                            <span>@TimeSpanToString(record.ClockOutTime.Value)</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (record.TotalBreakTime.HasValue)
                                                        {
                                                            var breakTime = record.TotalBreakTime.Value;
                                                            <span>
                                                                @breakTime.Hours Hr
                                                                @breakTime.Minutes.ToString("00") Mins
                                                                @breakTime.Seconds.ToString("00") Secs
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                    <td>
                                                        @if (record.ClockInTime.HasValue && record.ClockOutTime.HasValue)
                                                        {
                                                            // Calculate total working time
                                                            var totalDuration = record.ClockOutTime.Value - record.ClockInTime.Value;
                                                            var breakTime = record.TotalBreakTime ?? TimeSpan.Zero;
                                                            var workingTime = totalDuration - breakTime;

                                                            <span>
                                                                @workingTime.Hours Hr
                                                                @workingTime.Minutes.ToString("00") Mins
                                                                @workingTime.Seconds.ToString("00") Secs
                                                            </span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-muted">-</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="5" class="text-center text-muted py-4">
                                                    No attendance records found
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            @if (totalRecords > 0)
                            {
                                <div class="pagination-container" id="paginationContainer">
                                    <!-- Left side: Status indicators and info -->
                                    <div class="d-flex align-items-center gap-4">
                                        <!-- Pagination Info -->
                                        <div class="pagination-info">
                                            Showing @(((currentPage - 1) * pageSize) + 1)-@Math.Min(currentPage * pageSize, totalRecords) of @totalRecords records
                                        </div>

                                        <div class="pagination-status-indicators">
                                            <div class="status-indicator-item">
                                                <span class="pagination-status-dot status-dot-on-time"></span>
                                                <span>On Time</span>
                                            </div>
                                            <div class="status-indicator-item">
                                                <span class="pagination-status-dot status-dot-late"></span>
                                                <span>Late</span>
                                            </div>
                                        </div>

                                        <!-- Vertical separator -->
                                        <div class="vr" style="height: 20px; background-color: #D6E3F2;"></div>
                                    </div>

                                    <!-- Right side: Pagination Navigation - FIXED -->
                                    <nav aria-label="Attendance pagination">
                                        <ul class="pagination mb-0" id="paginationNav">
                                            <!-- Previous button -->
                                            <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                                                <a class="page-link" href="?month=@selectedMonth&year=@selectedYear&page=@(currentPage - 1)" onclick="event.preventDefault(); changePage(@(currentPage - 1));">
                                                    <span aria-hidden="true">&laquo;</span>
                                                </a>
                                            </li>

                                            <!-- Page numbers -->
                                            @{
                                                int startPage = Math.Max(1, currentPage - 2);
                                                int endPage = Math.Min(totalPages, startPage + 4);

                                                if (endPage - startPage < 4)
                                                {
                                                    startPage = Math.Max(1, endPage - 4);
                                                }
                                            }

                                            @for (int i = startPage; i <= endPage; i++)
                                            {
                                                <li class="page-item @(i == currentPage ? "active" : "")">
                                                    <a class="page-link" href="?month=@selectedMonth&year=@selectedYear&page=@i" onclick="event.preventDefault(); changePage(@i);">
                                                        @i
                                                    </a>
                                                </li>
                                            }

                                            <!-- Next button -->
                                            <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                                                <a class="page-link" href="?month=@selectedMonth&year=@selectedYear&page=@(currentPage + 1)" onclick="event.preventDefault(); changePage(@(currentPage + 1));">
                                                    <span aria-hidden="true">&raquo;</span>
                                                </a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Month/Year Picker Modal -->
<div class="modal fade" id="monthYearModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-calendar3 me-2"></i>Select Month & Year
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="modalMonthSelect" class="form-label">Month</label>
                    <select class="form-select" id="modalMonthSelect">
                        @{
                            var monthNames = new[] { "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" };
                        }
                        @for (int i = 0; i < monthNames.Length; i++)
                        {
                            @if (selectedMonth == i + 1)
                            {
                                <option value="@(i + 1)" selected>@monthNames[i]</option>
                            }
                            else
                            {
                                <option value="@(i + 1)">@monthNames[i]</option>
                            }
                        }
                    </select>
                </div>
                <div class="mb-3">
                    <label for="modalYearSelect" class="form-label">Year</label>
                    <div class="input-group">
                        <button class="btn btn-outline-secondary" type="button" id="decreaseYear">
                            <i class="bi bi-dash"></i>
                        </button>
                        <input type="number" class="form-control text-center" id="modalYearInput"
                               value="@selectedYear" min="2000" max="2099" />
                        <button class="btn btn-outline-secondary" type="button" id="increaseYear">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </div>
                <div class="d-grid gap-2">
                    <button type="button" class="btn btn-primary" id="applyMonthYear">
                        <i class="bi bi-check-circle me-2"></i>Apply
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="goToToday">
                        <i class="bi bi-calendar-today me-2"></i>Go to Today
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Details Modal -->
<div class="modal fade" id="attendanceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="attendanceDate">
                    <i class="bi bi-calendar-check me-2"></i>Attendance Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="attendance-details-container">
                    <!-- Loading state -->
                    <div class="loading-state">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                    <!-- Content will be inserted here by JavaScript -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    window.attendanceConfig = {
        selectedMonth: @selectedMonth,
        selectedYear: @selectedYear,
        currentPage: @currentPage,
        isOnBreak: @((todayAttendance?.IsOnBreak ?? false) ? "true" : "false"),
        @if (todayAttendance != null)
        {
                        <text>todayAttendance: {
                            clockInTime: '@(todayAttendance.ClockInTime?.ToString(@"hh\:mm\:ss") ?? "")',
                            clockOutTime: '@(todayAttendance.ClockOutTime?.ToString(@"hh\:mm\:ss") ?? "")',
                            isOnBreak: @(todayAttendance.IsOnBreak ? "true" : "false"),
                            hasTakenBreak: @(todayAttendance.HasTakenBreak ? "true" : "false"),
                            breakStartTime: '@(todayAttendance.BreakStartTime?.ToString("yyyy-MM-ddTHH:mm:ss") ?? "")',
                            @if (todayAttendance.TotalBreakTime != null)
                            {
                                            <text>totalBreakTime: {
                                                hours: @todayAttendance.TotalBreakTime.Value.Hours,
                                                minutes: @todayAttendance.TotalBreakTime.Value.Minutes,
                                                seconds: @todayAttendance.TotalBreakTime.Value.Seconds
                                            },</text>
                            }
                            hasClockIn: @(todayAttendance.ClockInTime != null ? "true" : "false"),
                            hasClockOut: @(todayAttendance.ClockOutTime != null ? "true" : "false")
                        },</text>
        }
        else
        {
                        <text>todayAttendance: null,</text>
        }
        // Add any other data your JavaScript needs
        pageSize: 10,
        totalRecords: @totalRecords,
        totalPages: @totalPages
    };
</script>

@section Scripts {
    <script src="~/js/attendance.js?v=@DateTime.Now.Ticks"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the page with configuration
            if (typeof initializeAttendancePage === 'function') {
                initializeAttendancePage(window.attendanceConfig);
            }
        });
    </script>
}

@functions {
    // Helper function to format TimeSpan
    public string TimeSpanToString(TimeSpan time)
    {
        var dateTime = DateTime.Today.Add(time);
        return dateTime.ToString("hh:mm tt");
    }

    // Overload for nullable TimeSpan
    public string TimeSpanToString(TimeSpan? time)
    {
        if (time.HasValue)
        {
            var dateTime = DateTime.Today.Add(time.Value);
            return dateTime.ToString("hh:mm tt");
        }
        return "-";
    }

    // Overload for DateTime (for BreakStartTime)
    public string DateTimeToTimeString(DateTime? dateTime)
    {
        if (dateTime.HasValue)
        {
            return dateTime.Value.ToString("hh:mm tt");
        }
        return "-";
    }

}