@model InternProject1.Models.EmployeeMonitoringViewModel

@{
    ViewData["Title"] = "Employee Attendance Monitoring";
    Layout = "_Layout";

    // FIX: Define currentPage to resolve context error
    var currentPage = 1;

    // CALCULATIONS BLOCK
    var totalEmployees = Model.Employees.Count;

    // Use TimeSpan.Zero to check for "empty" records instead of null
    var presentCount = Model.TodayAttendance.Count(a => a.ClockInTime != TimeSpan.Zero);

    var onTimeCount = Model.TodayAttendance.Count(a => a.ClockInTime != TimeSpan.Zero &&
        (a.ClockInTime.Hours < 9 || (a.ClockInTime.Hours == 9 && a.ClockInTime.Minutes == 0)));

    var lateCount = Model.TodayAttendance.Count(a => a.ClockInTime != TimeSpan.Zero &&
        !(a.ClockInTime.Hours < 9 || (a.ClockInTime.Hours == 9 && a.ClockInTime.Minutes == 0)));

    var absentCount = totalEmployees - presentCount;

    // ClockOutTime is likely nullable (TimeSpan?), so keep .HasValue logic
    var earlyDeparturesCount = Model.TodayAttendance.Count(a =>
        a.ClockOutTime.HasValue &&
        a.ClockOutTime.Value.Hours < 17 &&
        !(a.ClockOutTime.Value.Hours == 16 && a.ClockOutTime.Value.Minutes == 0));

    var timeOffCount = 0;
    var currentWeekNumber = GetWeekOfYear(DateTime.Now);
}

@functions {
    public int GetWeekOfYear(DateTime date)
    {
        var calendar = System.Globalization.CultureInfo.CurrentCulture.Calendar;
        return calendar.GetWeekOfYear(date, System.Globalization.CalendarWeekRule.FirstFourDayWeek, DayOfWeek.Monday);
    }
}

<style>
    /* (Keep your original CSS here) */
</style>

<div class="monitoring-container">
    <div class="container-fluid">
        <div class="monitoring-header">
            <div class="header-left">
                <h1>Employee Attendance Dashboard</h1>
            </div>
        </div>

        <div class="top-cards-section">
            <div class="big-card">
                <div class="stat-card">
                    <div class="real-time-header">
                        <div>
                            <h3 class="stat-label">Real-time Insights</h3>
                            <div class="date-display">
                                Today: <span class="day-name">@DateTime.Now.DayOfWeek</span>,
                                @DateTime.Now.ToString("MMMM dd, yyyy")
                            </div>
                        </div>
                    </div>
                    <a href="#" class="view-attendance-btn">
                        <i class="bi bi-eye me-2"></i>View Detailed Attendance
                    </a>
                </div>
            </div>

            <div class="regular-card card-2">
                <div class="stat-card">
                    <div class="stat-icon icon-total">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div class="stat-number">@totalEmployees</div>
                    <div class="stat-label">Total Employees</div>
                </div>
            </div>

            <div class="regular-card card-3">
                <div class="stat-card">
                    <div class="stat-icon icon-ontime">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="stat-number">@onTimeCount</div>
                    <div class="stat-label">On Time Today</div>
                </div>
            </div>

            <div class="regular-card card-4">
                <div class="stat-card">
                    <div class="stat-icon icon-absent">
                        <i class="bi bi-x-circle"></i>
                    </div>
                    <div class="stat-number">@absentCount</div>
                    <div class="stat-label">Absent Today</div>
                </div>
            </div>
        </div>
    </div>
</div>