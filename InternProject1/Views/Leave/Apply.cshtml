@model InternProject1.Models.LeaveRequest
@{
    ViewData["Title"] = "Leave Application";
    Layout = "_Layout";
    string today = DateTime.Now.ToString("yyyy-MM-dd");
}

<div class="container-fluid py-4">
    <div class="card border-0 shadow-sm p-5 mx-auto" style="max-width: 800px; background-color: #f8fbff;">
        <h4 class="mb-5 text-dark" style="text-decoration: underline;">Leave Application</h4>

        <div id="salaryWarning" class="alert alert-warning border-0 shadow-sm mb-4 d-none" style="background-color: #FFF3CD; color: #856404; border-radius: 12px;">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle-fill me-3 fs-4"></i>
                <div>
                    <strong>Salary Deduction Advisory:</strong>
                    You have insufficient balance for this leave type. Proceeding with this application may result in a <strong>salary deduction</strong> for the over-limit days.
                </div>
            </div>
        </div>

        <form asp-action="Apply" method="post">

            <div class="row mb-4 align-items-center">
                <label class="col-md-4 fw-semibold">Select Leave Type:</label>
                <div class="col-md-8">
                    <select asp-for="LeaveType" id="leaveType" class="form-select border-0 shadow-sm py-2 px-3 rounded-3"
                            style="background-color: #DDE7F2;" required>
                        <option value="" disabled selected>-- Select Type --</option>
                        <option value="Annual">Annual Leave (Balance: @ViewBag.AnnualBalance Days)</option>
                        <option value="MC">Medical Leave / MC (Balance: @ViewBag.MCBalance Days)</option>
                        <option value="Compassionate">Compassionate Leave (Balance: @ViewBag.CompassionateBalance Days)</option>

                        <option value="Maternity Leave">Maternity Leave (Balance: @ViewBag.MaternityBalance Days)</option>

                        <option value="Unpaid">Unpaid Leave</option>
                        <option value="Other">Other (Balance: @ViewBag.OtherBalance Days)</option>
                    </select>
                </div>
            </div>

            <div class="row mb-4 align-items-center">
                <label class="col-md-4 fw-semibold">Your Name:</label>
                <div class="col-md-8">
                    <input type="text" class="form-control border-0 shadow-sm py-2 px-3 rounded-3"
                           style="background-color: #DDE7F2;"
                           value="@Context.Session.GetString("UserName")" readonly />
                </div>
            </div>

            <div class="row mb-4 align-items-center">
                <label class="col-md-4 fw-semibold">Employee ID:</label>
                <div class="col-md-8">
                    <input type="hidden" asp-for="Employee_ID" value="@Context.Session.GetInt32("UserID")" />
                    <input type="text" class="form-control border-0 shadow-sm py-2 px-3 rounded-3"
                           style="background-color: #DDE7F2;"
                           value="@Context.Session.GetInt32("UserID")" readonly />
                </div>
            </div>

            <div class="row mb-4 align-items-center">
                <label class="col-md-4 fw-semibold">Enter Start Date:</label>
                <div class="col-md-8">
                    <input type="date" asp-for="Start_Date" id="startDate"
                           class="form-control border-0 shadow-sm py-2 px-3 rounded-3"
                           style="background-color: #DDE7F2;" min="@today" required />
                </div>
            </div>

            <div class="row mb-4 align-items-center">
                <label class="col-md-4 fw-semibold">Enter End Date:</label>
                <div class="col-md-8">
                    <input type="date" asp-for="End_Date" id="endDate"
                           class="form-control border-0 shadow-sm py-2 px-3 rounded-3"
                           style="background-color: #DDE7F2;" min="@today" required />
                </div>
            </div>

            <div class="row mb-5 align-items-start">
                <label class="col-md-4 fw-semibold mt-2">Enter Reasons:</label>
                <div class="col-md-8">
                    <textarea asp-for="Reasons" class="form-control border-0 shadow-sm py-2 px-3 rounded-3"
                              style="background-color: #DDE7F2;" rows="4"
                              placeholder="Describe why you are taking leave..." required></textarea>
                </div>
            </div>

            <div class="text-end mt-4">
                <button type="submit" class="btn btn-success px-5 py-2 me-3 rounded-3 shadow-sm"
                        style="background-color: #A5D6A7; border: none; color: #1B5E20;">
                    Submit
                </button>
                <a asp-controller="Home" asp-action="Index" class="btn btn-danger px-5 py-2 rounded-3 shadow-sm"
                   style="background-color: #EF9A9A; border: none; color: #B71C1C;">Cancel</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // Maps the dropdown values to the balances passed from the Controller
        const leaveBalances = {
            "Annual": @(ViewBag.AnnualBalance ?? 0),
            "MC": @(ViewBag.MCBalance ?? 0),
            "Compassionate": @(ViewBag.CompassionateBalance ?? 0),
            "Maternity Leave": @(ViewBag.MaternityBalance ?? 0), // Pulled from your new DB column
            "Other": @(ViewBag.OtherBalance ?? 0),
            "Unpaid": 0
        };

        function calculateAndCheck() {
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            const typeInput = document.getElementById('leaveType');
            const warning = document.getElementById('salaryWarning');

            // Prevent End Date from being before Start Date
            if (startInput.value) {
                endInput.min = startInput.value;
                if (endInput.value && endInput.value < startInput.value) {
                    endInput.value = startInput.value;
                }
            }

            // Calculate requested days and compare with balance
            if (startInput.value && endInput.value && typeInput.value) {
                const start = new Date(startInput.value);
                const end = new Date(endInput.value);
                const selectedType = typeInput.value;

                // Simple day difference calculation
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                // Logic for showing the warning alert
                if (selectedType === "Unpaid") {
                    warning.classList.remove('d-none');
                }
                else if (diffDays > (leaveBalances[selectedType] || 0)) {
                    warning.classList.remove('d-none');
                } else {
                    warning.classList.add('d-none');
                }
            }
        }

        // Add event listeners for real-time validation
        document.getElementById('startDate').addEventListener('change', calculateAndCheck);
        document.getElementById('endDate').addEventListener('change', calculateAndCheck);
        document.getElementById('leaveType').addEventListener('change', calculateAndCheck);
    </script>
}