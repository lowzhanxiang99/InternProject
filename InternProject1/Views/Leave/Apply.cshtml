@model InternProject1.Models.LeaveRequest
@using Microsoft.AspNetCore.Http
@{
    ViewData["Title"] = "Leave Application";
    Layout = "_Layout";
    string today = DateTime.Now.ToString("yyyy-MM-dd");
}

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="container-fluid py-5">
    <div class="mx-auto" style="max-width: 1000px;">

        <h2 class="mb-5 fw-bold" style="color: #2c3e50; border-bottom: 2px solid #eef2f7; padding-bottom: 15px;">
            Leave Application
        </h2>

        <div id="salaryWarning" class="alert alert-warning border-0 shadow-sm mb-5 d-none" style="border-radius: 15px;">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-circle-fill me-3 fs-4"></i>
                <div>
                    <strong>Salary Deduction Advisory:</strong> Insufficient balance. Over-limit days may be deducted from salary.
                </div>
            </div>
        </div>

        <form asp-action="Apply" method="post" id="leaveForm" class="pe-md-5">

            <div class="row mb-4 align-items-center">
                <label class="col-md-4 fs-5 fw-bold text-dark text-md-end pe-4">Select Leave Type:</label>
                <div class="col-md-7">
                    <select asp-for="LeaveType" id="leaveType" class="form-control premium-pill shadow-sm" required>
                        <option value="" disabled selected>-- Select Type --</option>
                        <option value="Annual">Annual Leave (Balance: @ViewBag.AnnualBalance)</option>
                        <option value="MC">Medical Leave / MC (Balance: @ViewBag.MCBalance)</option>
                        <option value="Compassionate">Compassionate (Balance: @ViewBag.CompassionateBalance)</option>
                        <option value="Maternity Leave">Maternity (Balance: @ViewBag.MaternityBalance)</option>
                        <option value="Unpaid">Unpaid Leave</option>
                        <option value="Other">Other (Balance: @ViewBag.OtherBalance)</option>
                    </select>
                </div>
            </div>

            <div class="row mb-4 align-items-center">
                <label class="col-md-4 fs-5 fw-bold text-dark text-md-end pe-4">Enter Your Name:</label>
                <div class="col-md-7">
                    <input type="text" class="form-control premium-pill shadow-sm bg-light-blue"
                           value="@Context.Session.GetString("UserName")" readonly />
                </div>
            </div>

            <div class="row mb-4 align-items-center">
                <label class="col-md-4 fs-5 fw-bold text-dark text-md-end pe-4">Enter Your ID:</label>
                <div class="col-md-7">
                    <input type="hidden" asp-for="Employee_ID" id="empId" value="@Context.Session.GetInt32("UserID")" />
                    <input type="text" class="form-control premium-pill shadow-sm bg-light-blue"
                           value="@Context.Session.GetInt32("UserID")" readonly />
                </div>
            </div>

            <div class="row mb-4 align-items-center">
                <label class="col-md-4 fs-5 fw-bold text-dark text-md-end pe-4">Enter Start Date:</label>
                <div class="col-md-7">
                    <input type="date" asp-for="Start_Date" id="startDate"
                           class="form-control premium-pill shadow-sm" min="@today" required />
                </div>
            </div>

            <div class="row mb-4 align-items-center">
                <label class="col-md-4 fs-5 fw-bold text-dark text-md-end pe-4">Enter End Date:</label>
                <div class="col-md-7">
                    <input type="date" asp-for="End_Date" id="endDate"
                           class="form-control premium-pill shadow-sm" min="@today" required />
                </div>
            </div>

            <div class="row mb-5 align-items-start">
                <label class="col-md-4 fs-5 fw-bold text-dark text-md-end pe-4 mt-2">Enter Reasons:</label>
                <div class="col-md-7">
                    <textarea asp-for="Reasons" class="form-control shadow-sm"
                              style="border-radius: 20px; padding: 15px; border: none; background-color: #dbe5f0;"
                              rows="5" placeholder="Enter Reasons" required></textarea>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-11 d-flex justify-content-end gap-3">
                    <button type="submit" class="btn btn-submit-modern">Submit</button>
                    <a asp-controller="Home" asp-action="Index" class="btn btn-cancel-modern">Cancel</a>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
    /* Premium Styling */
    .premium-pill {
        border-radius: 15px !important;
        padding: 12px 20px !important;
        border: none !important;
        background-color: #dbe5f0 !important;
        color: #555;
        font-weight: 500;
    }

    .bg-light-blue {
        background-color: #dbe5f0 !important;
    }

    .btn-submit-modern, .btn-cancel-modern {
        display: inline-flex !important;
        align-items: center;
        justify-content: center;
        border-radius: 15px !important;
        padding: 12px 60px !important;
        font-weight: bold !important;
        border: none !important;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        transition: all 0.2s;
        text-decoration: none !important;
        min-width: 180px;
    }

    .btn-submit-modern {
        background-color: #98d8a3 !important;
        color: #2d5a35 !important;
    }

    .btn-cancel-modern {
        background-color: #f9a8a8 !important;
        color: #7a2a2a !important;
    }

        .btn-submit-modern:hover, .btn-cancel-modern:hover {
            transform: translateY(-2px);
            filter: brightness(0.92);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

    .form-control:focus {
        box-shadow: 0 0 0 0.25rem rgba(219, 229, 240, 0.5) !important;
    }
</style>

@section Scripts {
    <script>
        const leaveBalances = {
            "Annual": @(ViewBag.AnnualBalance ?? 0),
            "MC": @(ViewBag.MCBalance ?? 0),
            "Compassionate": @(ViewBag.CompassionateBalance ?? 0),
            "Maternity Leave": @(ViewBag.MaternityBalance ?? 0),
            "Other": @(ViewBag.OtherBalance ?? 0),
            "Unpaid": 0
        };

        function calculateAndCheck() {
            const startInput = document.getElementById('startDate');
            const endInput = document.getElementById('endDate');
            const typeInput = document.getElementById('leaveType');
            const warning = document.getElementById('salaryWarning');

            if (startInput.value) {
                endInput.min = startInput.value;
            }

            if (startInput.value && endInput.value && typeInput.value) {
                const start = new Date(startInput.value);
                const end = new Date(endInput.value);
                const diffDays = Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1;
                const selectedType = typeInput.value;

                if (selectedType === "Unpaid" || diffDays > (leaveBalances[selectedType] || 0)) {
                    warning.classList.remove('d-none');
                } else {
                    warning.classList.add('d-none');
                }
                return diffDays;
            }
            return 0;
        }

        document.getElementById('leaveForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const days = calculateAndCheck();

            const empId = document.getElementById('empId').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            // Step 1: Check for duplicate leave dates via Controller
            try {
                const response = await fetch(`/Leave/CheckDuplicateLeave?employeeId=${empId}&start=${start}&end=${end}`);
                const data = await response.json();

                if (data.isDuplicate) {
                    Swal.fire({
                        title: 'Application Failed',
                        text: 'You have already applied for leave on these dates. Please check your history.',
                        icon: 'error',
                        confirmButtonColor: '#f9a8a8',
                        customClass: { popup: 'rounded-4' }
                    });
                    return; // Stop the process here
                }
            } catch (error) {
                console.error("Error checking leave dates:", error);
            }

            // Step 2: Show confirmation if no duplicates found
            Swal.fire({
                title: 'Confirm Application?',
                text: `You are applying for ${days} day(s) of leave.`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#98d8a3',
                cancelButtonColor: '#f9a8a8',
                confirmButtonText: 'Confirm',
                cancelButtonText: 'Edit',
                customClass: { popup: 'rounded-4' }
            }).then((result) => {
                if (result.isConfirmed) {
                    this.submit();
                }
            });
        });

        document.getElementById('startDate').addEventListener('change', calculateAndCheck);
        document.getElementById('endDate').addEventListener('change', calculateAndCheck);
        document.getElementById('leaveType').addEventListener('change', calculateAndCheck);
    </script>
}