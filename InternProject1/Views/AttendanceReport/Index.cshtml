@model IEnumerable<InternProject1.Models.StaffSummaryViewModel>

@{
    // 1. Get the current month from the URL or default to January 2026
    var selectedMonthLabel = Context.Request.Query["month"].ToString();
    if (string.IsNullOrEmpty(selectedMonthLabel)) { selectedMonthLabel = "January 2026"; }

    // 2. Data Logic
    // Since the ViewModel is a summary, we assume the Controller already filtered the list.
    // If the list is empty, it means no data exists for the selected month.
    var totalAttendance = Model?.Sum(s => s.AttendanceCount) ?? 0;
    var totalLate = Model?.Sum(s => s.LateCount) ?? 0;
    var totalLeave = Model?.Sum(s => s.LeaveCount) ?? 0;
    var totalAbsent = Model?.Sum(s => s.AbsentCount) ?? 0;

    bool hasData = Model != null && Model.Any();
}

<div class="container-fluid p-0" style="background-color: #f4f7f6; min-height: 100vh;">
    @* Header with Month Selection *@
    <div class="text-center py-3 mb-3 shadow-sm" style="background: linear-gradient(135deg, #BDD2E7 0%, #9bbad9 100%);">
        <h5 class="fw-bold m-0 text-dark">ATTENDANCE ANALYTICS</h5>

        <div class="dropdown mt-1">
            <button class="btn btn-white btn-sm dropdown-toggle shadow-sm px-3 py-1 border-0"
                    type="button" id="dateDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                    style="border-radius: 20px; font-size: 0.75rem; background-color: white;">
                <i class="bi bi-calendar3 me-1"></i> <span id="currentSelection">@selectedMonthLabel</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-center shadow border-0" aria-labelledby="dateDropdown" style="font-size: 0.8rem; border-radius: 12px;">
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="filterByMonth('January 2026')">January 2026</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="filterByMonth('February 2026')">February 2026</a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="filterByMonth('March 2026')">March 2026</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-primary fw-bold" href="#">View More...</a></li>
            </ul>
        </div>
    </div>

    <div class="container">
        @* Summary Cards *@
        <div class="row g-3 mb-4 justify-content-center">
            @foreach (var item in new[] {
                        new { Title = "Attendance", Count = totalAttendance, Color = "#4A77A5", Desc = "Present Work", Icon = "bi-person-check-fill" },
                        new { Title = "Late", Count = totalLate, Color = "#FFCC00", Desc = "Late Arrived", Icon = "bi-clock-history" },
                        new { Title = "Leave", Count = totalLeave, Color = "#99CCFF", Desc = "On Leave", Icon = "bi-calendar-check" },
                        new { Title = "Absent", Count = totalAbsent, Color = "#FF6666", Desc = "Total absent days", Icon = "bi-exclamation-triangle" }
                        })
            {
                <div class="col-6 col-md-3">
                    <div class="p-3 border-0 text-center shadow-sm h-100" style="background-color: white; border-radius: 15px; border-bottom: 4px solid @item.Color !important;">
                        <p class="text-uppercase mb-1 text-muted" style="font-size: 0.65rem; font-weight: 700; letter-spacing: 0.5px;">@item.Title</p>
                        <h3 class="fw-bold m-0" style="color: #333;">@item.Count</h3>
                        <div class="d-flex align-items-center justify-content-center mt-1 fw-semibold" style="color: @item.Color; font-size: 0.7rem;">
                            <i class="bi @item.Icon me-1"></i> @item.Desc
                        </div>
                    </div>
                </div>
            }
        </div>

        @* Chart Section with Empty State Overlay *@
        <div class="card border-0 shadow-sm mb-4 p-3" style="border-radius: 15px; background: white;">
            <p class="fw-bold text-muted mb-2 small" style="font-size: 0.8rem;"><i class="bi bi-graph-up-arrow me-2 text-primary"></i>Overall Summary</p>
            <div style="height: 260px; width: 100%; position: relative;">

                @if (!hasData)
                {
                    <div class="position-absolute top-50 start-50 translate-middle text-center w-100" style="z-index: 10;">
                        <i class="bi bi-clipboard2-x text-muted" style="font-size: 3rem; opacity: 0.3;"></i>
                        <p class="text-muted fw-bold mt-2">No records found for @selectedMonthLabel</p>
                    </div>
                }

                <canvas id="attendanceBarChart" style="@(hasData ? "" : "opacity: 0.1;")"></canvas>
            </div>
        </div>

        @* Employee Search *@
        <div class="row justify-content-center mb-4">
            <div class="col-lg-9">
                <div class="card border-0 shadow-sm p-4 text-center" style="border-radius: 20px; background: white;">
                    <div class="mb-3">
                        <h6 class="fw-bold m-0">Employee Detailed Log</h6>
                        <p class="text-muted" style="font-size: 0.75rem;">Search and select to view individual history</p>
                    </div>

                    <div class="row g-2 justify-content-center align-items-center">
                        <div class="col-md-8 text-start">
                            <select id="employeeSelect" class="form-select border-2 py-2" style="border-radius: 10px;">
                                <option value="">Start typing name...</option>
                                @if (ViewBag.EmployeeList != null)
                                {
                                    foreach (var emp in ViewBag.EmployeeList)
                                    {
                                        <option value="@emp.Employee_ID">@emp.FullName</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <button class="btn btn-primary w-100 fw-bold py-2" onclick="goToDetails()" style="border-radius: 10px; background: #4A77A5; border: none;">
                                VIEW REPORT
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @* Export Buttons *@
        <div class="d-flex justify-content-center gap-2 pb-5">
            <a asp-action="ExportToExcel" asp-route-month="@selectedMonthLabel" class="btn btn-outline-secondary btn-sm px-3" style="border-radius: 8px; font-size: 0.75rem;">
                <i class="bi bi-file-earmark-excel me-1"></i>Excel
            </a>
            <a asp-action="ExportToPdf" asp-route-month="@selectedMonthLabel" class="btn btn-outline-secondary btn-sm px-3" style="border-radius: 8px; font-size: 0.75rem;">
                <i class="bi bi-file-earmark-pdf me-1"></i>PDF
            </a>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        $(document).ready(function() {
            $('#employeeSelect').select2({
                placeholder: "Search for an employee...",
                allowClear: true,
                width: '100%'
            });

            const canvas = document.getElementById('attendanceBarChart');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Attendance', 'Late', 'Leave', 'Absent'],
                        datasets: [{
                            label: 'Total',
                            data: [@totalAttendance, @totalLate, @totalLeave, @totalAbsent],
                            backgroundColor: ['#4A77A5', '#FFCC00', '#99CCFF', '#FF6666'],
                            borderRadius: 8,
                            barThickness: 45
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { color: '#f0f0f0' }, ticks: { stepSize: 1, font: { size: 10 } } },
                            x: { grid: { display: false }, ticks: { font: { size: 11 } } }
                        }
                    }
                });
            }
        });

        function filterByMonth(monthYear) {
            // This reloads the page with the selected month in the URL
            window.location.href = window.location.pathname + '?month=' + encodeURIComponent(monthYear);
        }

        function goToDetails() {
            var id = $('#employeeSelect').val();
            if (id) {
                window.location.href = '/AttendanceReport/EmployeeDetails/' + id;
            } else {
                alert("Please select an employee name first.");
            }
        }
    </script>
}