@model InternProject1.Models.EmployeeProfileViewModel

@{
    ViewData["Title"] = "My Account";
}

<!-- Add Cropper.js CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />

<!-- Add Poppins Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
    body {
        font-family: 'Poppins', sans-serif;
    }

    .profile-card {
        background: #FFFFFF;
        border: 1px solid #E3F3FD;
        box-shadow: 0px 1px 4px rgba(88, 134, 166, 0.25);
        border-radius: 12px;
        overflow: hidden;
        max-width: 1480px;
        margin: 0 auto;
    }

    .profile-header {
        background: linear-gradient(92.21deg, #AAD9F9 16.95%, #84CBFC 88.66%);
        height: 130px;
        position: relative;
        border-radius: 12px 12px 0 0;
    }

    .profile-picture-wrapper {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        top: 5px;
        z-index: 10;
    }

    .profile-picture-container {
        width: 180px;
        height: 180px;
        border-radius: 50%;
        border: 3.57px solid #FFFFFF;
        box-shadow: 0px 0.71px 2.86px rgba(29, 155, 240, 0.25);
        overflow: hidden;
        background: #f8f9fa;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
    }

        .profile-picture-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .camera-icon {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 32px;
        height: 32px;
        background: #E3F3FD;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
    }

        .camera-icon:hover {
            background: #d0e9f9;
        }

    .profile-name-section {
        text-align: center;
        margin-top: 12px;
    }

    .profile-name {
        font-weight: 600;
        font-size: 24px;
        line-height: 24px;
        color: #1F4062;
        margin: 0;
    }

    .profile-role {
        font-weight: 400;
        font-size: 24px;
        line-height: 24px;
        color: #2C5B8C;
        margin: 12px 0 0 0;
    }

    .action-buttons {
        position: absolute;
        right: 48px;
        top: 47px;
        display: flex;
        gap: 32px;
    }

    .action-btn {
        width: 36px;
        height: 36px;
        background: #FFFFFF;
        box-shadow: 0px 1px 4px rgba(88, 134, 166, 0.25);
        border-radius: 48px;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s;
    }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0px 2px 8px rgba(88, 134, 166, 0.35);
        }

    .account-details-section {
        padding: 160px 100px 68px 100px;
    }

    .section-title {
        font-weight: 500;
        font-size: 18px;
        line-height: 27px;
        color: #122539;
        padding: 4px 0;
        border-bottom: 1px solid #83ACD8;
        margin-bottom: 32px;
    }

    .details-grid {
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .details-row {
        display: flex;
        gap: 32px;
    }

    .detail-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .detail-label {
        font-weight: 400;
        font-size: 14px;
        line-height: 20px;
        color: #5A91CB;
    }

    .detail-value {
        font-weight: 400;
        font-size: 16px;
        line-height: 24px;
        color: #122539;
    }

    .edit-form {
        display: none;
    }

        .edit-form.active {
            display: block;
        }

    .form-group {
        flex: 1;
    }

    .form-label {
        font-weight: 400;
        font-size: 14px;
        line-height: 20px;
        color: #5A91CB;
        margin-bottom: 4px;
    }

    .form-control {
        font-weight: 400;
        font-size: 16px;
        line-height: 24px;
        color: #122539;
        border: 1px solid #E3F3FD;
        border-radius: 8px;
        padding: 8px 12px;
    }

        .form-control:focus {
            border-color: #83ACD8;
            box-shadow: 0 0 0 0.2rem rgba(131, 172, 216, 0.25);
        }

    .btn-save {
        background: linear-gradient(92.21deg, #AAD9F9 16.95%, #84CBFC 88.66%);
        border: none;
        color: #1F4062;
        font-weight: 500;
        padding: 10px 24px;
        border-radius: 8px;
        transition: all 0.3s;
    }

        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0px 4px 8px rgba(88, 134, 166, 0.35);
        }

    .btn-cancel {
        background: #FFFFFF;
        border: 1px solid #E3F3FD;
        color: #122539;
        font-weight: 500;
        padding: 10px 24px;
        border-radius: 8px;
        transition: all 0.3s;
    }

        .btn-cancel:hover {
            background: #f8f9fa;
        }

    }
</style>

<div class="container-fluid p-0">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show mx-4 mb-4" role="alert">
            <i class="bi bi-check-circle me-2"></i>@TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show mx-4 mb-4" role="alert">
            <i class="bi bi-exclamation-circle me-2"></i>@TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="profile-card">
        <!-- Header with Gradient Background -->
        <div class="profile-header">
            <!-- Action Buttons -->
            <div class="action-buttons">
                <button type="button" class="action-btn" id="editBtn" title="Edit Profile">
                    <i class="bi bi-pencil" style="color: #1F4062; font-size: 20px;"></i>
                </button>
                <button type="button" class="action-btn" title="Change Password">
                    <i class="bi bi-shield-lock" style="color: #1F4062; font-size: 20px;"></i>
                </button>
            </div>

            <!-- Profile Picture -->
            <div class="profile-picture-wrapper">
                <div class="profile-picture-container">
                    @if (!string.IsNullOrEmpty(Model.ProfilePicturePath))
                    {
                        <img src="@Model.ProfilePicturePath" alt="Profile" id="currentProfilePic" />
                    }
                    else
                    {
                        <i class="bi bi-person text-secondary" style="font-size: 5rem;"></i>
                    }
                    <div class="camera-icon" onclick="document.getElementById('profilePictureInput').click()">
                        <i class="bi bi-camera" style="color: #1F4062; font-size: 16px;"></i>
                    </div>
                </div>

                <div class="profile-name-section">
                    <h1 class="profile-name">@Model.First_Name @Model.Last_Name</h1>
                    <p class="profile-role">@Model.Role</p>
                </div>
            </div>

            <input type="file" id="profilePictureInput" accept="image/*" class="d-none" />
        </div>

        <!-- Account Details Section -->
        <div class="account-details-section">
            <!-- View Mode -->
            <div id="viewMode">
                <h2 class="section-title">Account Details</h2>

                <div class="details-grid">
                    <div class="details-row">
                        <div class="detail-item">
                            <span class="detail-label">Employee ID</span>
                            <span class="detail-value">@Model.Employee_ID</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Official Email ID</span>
                            <span class="detail-value">@Model.Employee_Email</span>
                        </div>
                    </div>

                    <div class="details-row">
                        <div class="detail-item">
                            <span class="detail-label">First Name</span>
                            <span class="detail-value">@Model.First_Name</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Last Name</span>
                            <span class="detail-value">@Model.Last_Name</span>
                        </div>
                    </div>

                    <div class="details-row">
                        <div class="detail-item">
                            <span class="detail-label">Date of Birth</span>
                            <span class="detail-value">@Model.Date_of_Birth.ToString("dd/MM/yyyy")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Gender</span>
                            <span class="detail-value">@Model.Gender</span>
                        </div>
                    </div>

                    <div class="details-row">
                        <div class="detail-item">
                            <span class="detail-label">Phone Number</span>
                            <span class="detail-value">@Model.Employee_Phone</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Shift Time</span>
                            <span class="detail-value">@(Model.Shift_ID != null ? "10:00:00 - 19:00:00" : "N/A")</span>
                        </div>
                    </div>

                    <div class="details-row">
                        <div class="detail-item">
                            <span class="detail-label">Role</span>
                            <span class="detail-value">@Model.Role</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Branch</span>
                            <span class="detail-value">@Model.Branch</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Mode -->
            <div id="editMode" class="edit-form">
                <h2 class="section-title">Edit Account Details</h2>

                <form asp-action="UpdateProfile" method="post">
                    <div class="details-grid">
                        <div class="details-row">
                            <div class="form-group">
                                <label class="form-label">Employee ID</label>
                                <input type="text" class="form-control" value="@Model.Employee_ID" disabled />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Official Email ID</label>
                                <input asp-for="Employee_Email" type="email" class="form-control" required />
                            </div>
                        </div>

                        <div class="details-row">
                            <div class="form-group">
                                <label class="form-label">First Name</label>
                                <input asp-for="First_Name" class="form-control" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name</label>
                                <input asp-for="Last_Name" class="form-control" required />
                            </div>
                        </div>

                        <div class="details-row">
                            <div class="form-group">
                                <label class="form-label">Date of Birth</label>
                                <input asp-for="Date_of_Birth" type="date" class="form-control" required />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gender</label>
                                <select asp-for="Gender" class="form-control" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                        </div>

                        <div class="details-row">
                            <div class="form-group">
                                <label class="form-label">Phone Number</label>
                                <input asp-for="Employee_Phone" type="tel" class="form-control" />
                            </div>
                            <div class="form-group">
                                <label class="form-label">Branch</label>
                                <input type="text" class="form-control" value="@Model.Branch" disabled />
                            </div>
                        </div>

                        <div class="details-row mt-4">
                            <div class="d-flex gap-3">
                                <button type="submit" class="btn btn-save">
                                    <i class="bi bi-check-circle me-2"></i>Save Changes
                                </button>
                                <button type="button" class="btn btn-cancel" id="cancelBtn">
                                    <i class="bi bi-x-circle me-2"></i>Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Crop Modal -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(92.21deg, #AAD9F9 16.95%, #84CBFC 88.66%);">
                <h5 class="modal-title" id="cropModalLabel" style="color: #1F4062; font-weight: 600;">
                    <i class="bi bi-crop me-2"></i>Crop Profile Picture
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="img-container mb-3">
                    <img id="imageToCrop" style="max-width: 100%; display: block;">
                </div>
                <div class="text-muted small">
                    <i class="bi bi-info-circle me-1"></i>
                    Drag to move, scroll to zoom, use corners to resize the crop area
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-cancel" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-save" id="cropAndUpload">
                    <span class="spinner-border spinner-border-sm d-none me-2" id="uploadSpinner"></span>
                    <i class="bi bi-check-circle me-2" id="uploadIcon"></i>
                    <span id="uploadText">Crop & Upload</span>
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <!-- Add Cropper.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

    <script>
        // Toggle Edit Mode
        const viewMode = document.getElementById('viewMode');
        const editMode = document.getElementById('editMode');
        const editBtn = document.getElementById('editBtn');
        const cancelBtn = document.getElementById('cancelBtn');

        editBtn.addEventListener('click', function() {
            viewMode.style.display = 'none';
            editMode.classList.add('active');
        });

        cancelBtn.addEventListener('click', function() {
            viewMode.style.display = 'block';
            editMode.classList.remove('active');
        });

        // Image Cropping Functionality
        let cropper;
        const fileInput = document.getElementById('profilePictureInput');
        const imageToCrop = document.getElementById('imageToCrop');
        const cropModalElement = document.getElementById('cropModal');
        const cropModal = new bootstrap.Modal(cropModalElement);
        const uploadSpinner = document.getElementById('uploadSpinner');
        const uploadIcon = document.getElementById('uploadIcon');
        const uploadText = document.getElementById('uploadText');
        const cropButton = document.getElementById('cropAndUpload');

        fileInput.addEventListener('change', function(e) {
            const files = e.target.files;
            if (files && files.length > 0) {
                const file = files[0];

                if (!file.type.match('image.*')) {
                    alert('Please select an image file (JPG, PNG, etc.)');
                    fileInput.value = '';
                    return;
                }

                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size should be less than 5MB');
                    fileInput.value = '';
                    return;
                }

                const reader = new FileReader();

                reader.onload = function(event) {
                    imageToCrop.src = event.target.result;
                    cropModal.show();

                    if (cropper) {
                        cropper.destroy();
                    }

                    cropper = new Cropper(imageToCrop, {
                        aspectRatio: 1,
                        viewMode: 1,
                        autoCropArea: 1,
                        responsive: true,
                        restore: false,
                        guides: true,
                        center: true,
                        highlight: false,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        toggleDragModeOnDblclick: false,
                        dragMode: 'move',
                        background: true,
                        modal: true,
                        zoomOnWheel: true,
                        zoomOnTouch: true,
                        minCropBoxWidth: 100,
                        minCropBoxHeight: 100
                    });
                };

                reader.readAsDataURL(file);
            }
        });

        cropButton.addEventListener('click', async function() {
            if (!cropper) return;

            uploadSpinner.classList.remove('d-none');
            uploadIcon.classList.add('d-none');
            uploadText.textContent = 'Uploading...';
            cropButton.disabled = true;

            try {
                const canvas = cropper.getCroppedCanvas({
                    width: 400,
                    height: 400,
                    imageSmoothingEnabled: true,
                    imageSmoothingQuality: 'high'
                });

                canvas.toBlob(async function(blob) {
                    const formData = new FormData();
                    formData.append('croppedImage', blob, 'profile.jpg');

                    try {
                        const response = await fetch('@Url.Action("UploadCroppedImage", "MyAccount")', {
                            method: 'POST',
                            body: formData
                        });

                        const data = await response.json();

                        if (data.success) {
                            const timestamp = new Date().getTime();
                            document.getElementById('currentProfilePic').src = data.path + '?t=' + timestamp;

                            cropModal.hide();

                            const successAlert = document.createElement('div');
                            successAlert.className = 'alert alert-success alert-dismissible fade show mx-4 mb-4';
                            successAlert.innerHTML = `
                                <i class="bi bi-check-circle me-2"></i>Profile picture updated successfully!
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            `;
                            document.querySelector('.container-fluid').insertBefore(successAlert, document.querySelector('.profile-card'));

                            setTimeout(() => {
                                successAlert.classList.remove('show');
                                setTimeout(() => successAlert.remove(), 150);
                            }, 3000);

                            setTimeout(() => {
                                location.reload();
                            }, 1500);
                        } else {
                            alert('Failed to upload image: ' + (data.message || 'Unknown error'));
                        }
                    } catch (error) {
                        console.error('Upload error:', error);
                        alert('Failed to upload image. Please try again.');
                    } finally {
                        uploadSpinner.classList.add('d-none');
                        uploadIcon.classList.remove('d-none');
                        uploadText.textContent = 'Crop & Upload';
                        cropButton.disabled = false;
                    }
                }, 'image/jpeg', 0.95);

            } catch (error) {
                console.error('Crop error:', error);
                alert('Failed to crop image. Please try again.');
                uploadSpinner.classList.add('d-none');
                uploadIcon.classList.remove('d-none');
                uploadText.textContent = 'Crop & Upload';
                cropButton.disabled = false;
            }
        });

        cropModalElement.addEventListener('hidden.bs.modal', function() {
            if (cropper) {
                cropper.destroy();
                cropper = null;
            }
            fileInput.value = '';
        });
    </script>
}